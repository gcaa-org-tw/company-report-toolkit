import{_ as je}from"./nuxt-link.857a2bfe.js";import{f as te,r as p,h as v,B as _e,z as Y,o as f,c as b,a as t,F as K,y as re,C as le,i as a,t as H,q as Z,v as we,s as be,D as ye,m as Be,A as ie,_ as oe,b as X,w as Ke,d as A,j as B,p as Pe,e as ke,L as $e,u as De,E as ae,l as Ge,G as Ue,H as We,I as ce,J as he,K as qe,g as Je,M as Qe}from"./entry.0f2fa65d.js";import{_ as ee,a as Xe}from"./lodash.512a68f9.js";import{a as Ye,_ as Ze,b as et}from"./SinglePdfPage.c8c91576.js";import{_ as tt}from"./AnswerPanel.vue.96ff0400.js";import{u as Se}from"./useProfessionApi.e687d293.js";import{u as ot}from"./index.8089a7a1.js";import{u as at}from"./useReport.a9e846d4.js";const st={class:"searchPanel"},nt={class:"flex mt2"},rt={class:"flex flex-wrap"},lt=["onClick"],it={class:"f6 dark-gray mv1"},ct=["onClick"],ut={class:"flex-none dark-gray"},dt=["innerHTML"],Q=15,pt=te({__name:"SearchPanel",props:{report:{},fieldMeta:{}},emits:["matched-pages","page"],setup(P,{emit:m}){const s=P,I=Be(),N=Ye(I.public.algoliaAppId,I.public.algoliaSearchApiKey).initIndex(I.public.algoliaIndexName),x=p(""),h=p(""),d=p([]),y=p(null),w=v(()=>h.value||x.value||"");_e(()=>{s.fieldMeta.keywords.length&&(x.value=s.fieldMeta.keywords[0])}),Y([x,h],([o,_],[n,L])=>{o!==n&&o?h.value="":_!==L&&_&&(x.value="")});function S(o){x.value=o}_e(()=>{w.value&&l()});async function l(){if(!w.value){d.value=[],y.value=null;return}const{hits:o}=await N.search(w.value,{facetFilters:[`company:${s.report.company.id}`,`year:${s.report.year}`],hitsPerPage:100});d.value=o.filter(_=>_.page<=s.report.totalPages),y.value=null}Y(d,o=>{const _=o.map(n=>n.page);m("matched-pages",_)});function M(o){o=o.replace(/\n/g,"");const _=`${w.value||""}`,n=o.indexOf(_),L=_.length+Q;if(n<0)return o.slice(0,L*2);const z=_.length;let V=o.slice(0,n);const g=`${o.slice(n+z,n+z+Q)}...`;if(n>Q)V=`...${o.slice(n-Q,n)}`;else return o.slice(0,L*2)+"...";return`${ee.escape(V)}<b class="underline">${_}</b>${ee.escape(g)}`}async function E(o){y.value===o?m("page",{highlight:"",page:1}):y.value=o,await ie(),m("page",{highlight:w.value,page:o.page})}function R(o){return o+(s.report.pageOffset||0)}return(o,_)=>(f(),b("div",st,[t("div",nt,[t("div",rt,[(f(!0),b(K,null,re(o.fieldMeta.keywords,n=>(f(),b("button",{class:le(["searchPanel__keyword pointer ba b--moon-gray br1",{"searchPanel__keyword--active":n===a(w)}]),key:n,onClick:L=>S(n)},H(n),11,lt))),128)),Z(t("input",{class:"mt1 f6 w-100 searchPanel__input","onUpdate:modelValue":_[0]||(_[0]=n=>be(h)?h.value=n:null),placeholder:"自訂關鍵字"},null,512),[[we,a(h),void 0,{trim:!0}]])])]),Z(t("div",it,[(f(!0),b(K,null,re(a(d),n=>(f(),b("div",{class:le(["flex mv2 dim pointer",{b:n===a(y)}]),key:n.page,onClick:L=>E(n)},[t("div",ut,"頁"+H(R(n.page)),1),t("div",{class:"pl2",innerHTML:M(n.content)},null,8,dt)],10,ct))),128))],512),[[ye,a(d).length]])]))}});const ft=oe(pt,[["__scopeId","data-v-009febed"]]),_t=oe(tt,[["__scopeId","data-v-6ffd8836"]]),U=P=>(Pe("data-v-aaa39382"),P=P(),ke(),P),ht={class:"editorControl"},gt={class:"ph3"},vt=U(()=>t("i",{class:"fa-solid fa-arrow-left mr1"},null,-1)),mt={class:"editorControl__keepTop mt2 pv2 ph3 mb2 bb b--moon-gray"},wt={class:"fw6 f4 mv0 black"},bt={class:"ph3"},yt={class:"gray f6 mt0 pb2 mb3 bb b--moon-gray lh-copy"},Pt={class:"editorControl__keywordSection pb2 mb3"},kt=U(()=>t("div",{class:"editorControl__keepMiddle fw5 mb1"},"相關關鍵字",-1)),$t=U(()=>t("div",{class:"f6 gray"},"點選以下關鍵字，或是自行輸入，就能搜出相關頁面",-1)),St={key:0,class:"editorControl__keepBottom pv2 ph3 bt ba b--moon-gray shadow-1 br2"},Ct={class:"flex justify-end"},It=U(()=>t("i",{class:"fa-solid fa-eye ml2 f7"},null,-1)),xt=U(()=>t("i",{class:"fa-solid fa-eye-slash ml2 f7"},null,-1)),Mt={class:"mt2"},Lt=te({__name:"EditorControl",props:{report:{},reportField:{},fieldMeta:{},focusedPage:{}},emits:["page","matched-pages","next","prev","report-field"],setup(P,{emit:m}){const s=P,{isCollaborator:I}=Se(),k=v(()=>({name:"profession-report-reportId",params:{reportId:s.report.id}}));function N(l){m("matched-pages",l)}function x(l){m("page",l)}const h=p(!1);function d(){h.value=!h.value}function y(l){m("report-field",l),w()}function w(){m("next")}function S(){m("prev")}return(l,M)=>{const E=je,R=ft,o=_t;return f(),b("div",ht,[t("div",gt,[X(E,{class:"flex f6 gray items-center no-underline dim pt3",to:a(k)},{default:Ke(()=>[vt,A(H(l.report.company.abbreviation)+" "+H(l.report.year)+" 報告書",1)]),_:1},8,["to"])]),t("div",mt,[t("h1",wt,H(l.fieldMeta.name),1)]),t("div",bt,[t("p",yt,H(l.fieldMeta.description),1),t("div",{class:"flex justify-between items-center mb3 mt2 pb3 bb b--moon-gray"},[t("button",{class:"editorControl__nav",onClick:S},"往上個欄位"),t("button",{class:"editorControl__nav",onClick:w},"往下個欄位")]),t("div",Pt,[kt,$t,X(R,{report:l.report,"field-meta":l.fieldMeta,onMatchedPages:N,onPage:x},null,8,["report","field-meta"])])]),a(I)?(f(),b("div",St,[t("div",Ct,[t("button",{class:"pv2 ph3 ba bg-dark-gray white br2 pointer f6 flex items-baseline",onClick:d},[a(h)?(f(),b(K,{key:0},[A("展開填答 x 驗證區"),It],64)):(f(),b(K,{key:1},[A("收合填答 x 驗證區"),xt],64))])]),Z(t("div",Mt,[X(o,{report:l.report,"report-field":l.reportField,"field-meta":l.fieldMeta,"focused-page":l.focusedPage,onNext:y},null,8,["report","report-field","field-meta","focused-page"])],512),[[ye,!a(h)]])])):B("",!0)])}}});const Vt=oe(Lt,[["__scopeId","data-v-aaa39382"]]),W=P=>(Pe("data-v-bd879947"),P=P(),ke(),P),Et={class:"reportViewer"},Tt={class:"reportViewer__control pr2"},Ft={class:"bb b--moon-gray flex items-center justify-between pv2"},Ot={class:"flex items-center pl3"},Nt=W(()=>t("i",{class:"fa-solid fa-plus"},null,-1)),Rt=W(()=>t("i",{class:"fa-solid fa-minus"},null,-1)),At=W(()=>t("i",{class:"fa-solid fa-arrows-left-right"},null,-1)),Ht=W(()=>t("i",{class:"fa-solid fa-arrows-up-down"},null,-1)),zt={key:0,class:"reportViewer__content w-100"},jt=["onClick"],Bt=W(()=>t("div",{class:"flex flex-column items-center justify-around h-100 f3 fw6"},[t("div",{class:"reportViewer__maskLabel pv3 ph4 br2"},"設定為第一頁"),t("div",{class:"reportViewer__maskLabel pv3 ph4 br2"},"設定為第一頁"),t("div",{class:"reportViewer__maskLabel pv3 ph4 br2"},"設定為第一頁")],-1)),Kt=[Bt],se="https://cdn.jsdelivr.net/npm/pdfjs-dist@3.9.179",Dt="https://gcaa-static.s3.ap-northeast-3.amazonaws.com/company-report-toolkit",ne=10,Gt=100,Ut=60,ge=.1,ve=100,Wt=te({__name:"PdfViewer",props:{page:{default:1},year:{default:2019},report:{},highlight:{default:""},matchedPages:{default(){return[]}}},emits:["view-page","page","reload"],setup(P,{emit:m}){const s=P,I=$e(),{feathers:k,isCollaborator:N}=Se();De({link:[{rel:"stylesheet",href:`${se}/web/pdf_viewer.css`}]});const x=p(!1),h=p(void 0),d=p([]),y=p(0),w=ae({}),S=p([null]),l=p(1),M=p(1),E=v({get(){return M.value+(s.report.pageOffset||0)},set(e){const r=Number.parseInt(e,10)-(s.report.pageOffset||0);Te(r)}}),R=v(()=>{const e=s.report.pageOffset||0;return e?`${s.report.totalPages+e} + ${Math.abs(e)}`:s.report.totalPages}),o=p(!1);function _(){s.report.hasSetPageOffset||!N.value?o.value=!1:(o.value=!0,I.add({type:"warning",text:"歡迎光臨，我們先校正報告書的第一頁吧 🍥",duration:5e3}))}const n=()=>{o.value=!o.value},L=v(()=>o.value?"取消設定報告第一頁":"頁次對不上？點此調整");async function z(e){const r=1-e;try{await k.app.service("report").patch(s.report.id,{pageOffset:r}),m("reload"),o.value=!1}catch(c){throw c.message&&I.add({type:"error",text:c.message}),c}}const V=p("fit-width"),g=p({pdfSize:{width:0,height:0},widthScale:0,heightScale:0,customScale:0}),T=v(()=>{if(!g.value.widthScale||!pe.value)return null;let e=1;switch(V.value){case"custom":e=g.value.customScale;break;case"fit-height":e=g.value.heightScale;break;case"fit-width":default:e=g.value.widthScale}return e=e||1,{scale:e,width:g.value.pdfSize.width*e,height:g.value.pdfSize.height*e}});Ge(()=>{ue()}),Ue(()=>{clearTimeout(h.value)});const i=v(()=>S.value[0]&&T.value),F=v(()=>`${Dt}/${s.year}/${s.report.company.id}`),O=v(()=>s.highlight+"");function D(){return!!window&&!!window.pdfjsLib&&!!window.pdfjsViewer}function ue(){h.value=setTimeout(async()=>{const e=D();e?(window.pdfjsLib.GlobalWorkerOptions.workerSrc=`${se}/build/pdf.worker.js`,await ie()):ue(),x.value=e},Gt)}async function de(e){const r=window.pdfjsLib,c=`${se}/cmaps/`,C=e%ne||ne,u=Le(e);w.value[u]||(w.value[u]=r.getDocument({url:`${F.value}/${u}.pdf`,cMapUrl:c,cMapPacked:!0,enableXfa:!0}));const $=await w.value[u].promise;return Ce($),{document:$,page:C}}async function Ce(e){if(g.value.widthScale)return;const r=await e.getPage(1),{width:c,height:C}=r.getViewport({scale:1});g.value.pdfSize={width:c,height:C};const u=j.value,$=u.clientWidth,J=u.clientHeight,He=Number.parseInt(getComputedStyle(u).paddingLeft),ze=$-He*2;g.value.widthScale=ze/c,g.value.heightScale=J/C}const q=v(()=>{var e,r;return T.value?{width:`${(e=T.value)==null?void 0:e.width}px`,height:`${(r=T.value)==null?void 0:r.height}px`}:{}}),Ie=v(()=>q.value.height?{...q.value,marginTop:`-${q.value.height}`}:{});async function xe(){const e=await de(1);S.value[0]={pdf:ae(e)}}function Me(){w.value={},S.value=Array(s.report.totalPages).fill(null),V.value="fit-width",g.value.widthScale=0}function Le(e){return`${Math.ceil(e/ne)}`.padStart(3,"0")}async function G(e,{forceLoad:r=!1,anchor:c=0}={}){if(!r&&d.value.length){d.value.includes(e)||d.value.unshift(e);return}const C=e-1;if(C>=S.value.length)throw new Error(`Invalid page number: ${e}`);if(r||(d.value.push(e),c&&(y.value=c)),!S.value[C]){const u=await de(e);S.value[C]={pdf:ae(u),highlight:s.matchedPages.includes(e)?O.value:""}}d.value.pop(),d.value.length?G(d.value[0],{forceLoad:!0}):setTimeout(()=>{y.value=0},ve)}const Ve=ee.debounce(e=>{G(e)},100),pe=ot(),j=p(null);Xe(()=>F.value&&!x.value&&!pe.value,()=>{Me(),xe(),_()});function Ee(e){const c=j.value.querySelectorAll(".reportViewer__page")[e-1];return c==null?void 0:c.offsetTop}function Te(e){e<1||e>s.report.totalPages||Number.isNaN(e)||(fe(e),m("page",e))}async function fe(e){const r=Ee(e),c=G(e,{anchor:r});e>1&&G(e-1),e<s.report.totalPages&&G(e+1),r&&j.value.scrollTo({top:r}),await c,M.value=e}Y(()=>s.page,async()=>{await fe(s.page)});function Fe(){var e;g.value.customScale=(((e=T.value)==null?void 0:e.scale)||1)*(1+ge),V.value="custom"}function Oe(){var e;g.value.customScale=(((e=T.value)==null?void 0:e.scale)||1)*(1-ge),V.value="custom"}function Ne(){V.value="fit-width"}function Re(){V.value="fit-height"}Y(T,async(e,r)=>{if(!e||!r||!j.value)return;const c=j.value,C=c.clientHeight/2,u=(c.scrollTop+C)/c.scrollHeight;await ie();const $=c.scrollHeight*u-C;y.value=$,setTimeout(()=>{y.value=0},ve)});const Ae=ee.debounce(e=>{e!==l.value&&(M.value=l.value,l.value=e,m("view-page",M.value))},Ut);return(e,r)=>{const c=Ze,C=et;return f(),b("div",Et,[t("div",Tt,[t("div",Ft,[t("div",Ot,[Z(t("input",{class:"reportViewer__pageInput b--moon-gray ba ph1 mr1","onUpdate:modelValue":r[0]||(r[0]=u=>be(E)?E.value=u:null),onKeyup:r[1]||(r[1]=We(u=>u.target.blur(),["enter"]))},null,544),[[we,a(E),void 0,{lazy:!0}]]),A("頁 / 共 "+H(a(R))+" 頁",1),a(N)?(f(),b("button",{key:0,class:"reportViewer__button ml2 gray",onClick:n},H(a(L)),1)):B("",!0)]),t("div",{class:"flex items-center"},[t("button",{class:"reportViewer__button",onClick:Fe},[Nt,A("放大")]),t("button",{class:"reportViewer__button",onClick:Oe},[Rt,A("縮小")]),t("button",{class:"reportViewer__button",onClick:Ne},[At,A("滿頁寬")]),t("button",{class:"reportViewer__button",onClick:Re},[Ht,A("滿頁高")])])])]),t("div",{class:"reportViewer__scrollContainer relative",ref_key:"scrollerEle",ref:j},[a(i)?(f(),b("div",zt,[(f(!0),b(K,null,re(a(S),(u,$)=>(f(),b(K,{key:$},[u?(f(),ce(C,qe({key:1,class:"reportViewer__page"},u.pdf,{class:[`thePage--${$+1}`],highlight:u.highlight,"page-anchor":a(y),scale:a(T).scale,onVisible:J=>a(Ae)($+1)}),null,16,["class","highlight","page-anchor","scale","onVisible"])):(f(),ce(c,{key:0,class:le(["reportViewer__page",[`theEmpty--${$+1}`]]),style:he(a(q)),"page-number":$+1,onVisible:J=>a(Ve)($+1)},null,8,["style","class","page-number","onVisible"])),a(o)?(f(),b("div",{key:2,class:"reportViewer__page reportViewer__page--mask center pointer",style:he(a(Ie)),onClick:J=>z($+1)},Kt,12,jt)):B("",!0)],64))),128))])):B("",!0)],512)])}}});const qt=oe(Wt,[["__scopeId","data-v-bd879947"]]),Jt={key:0,class:"editor"},Qt={class:"editor__viewer"},me="看完收工！ 🎉 找找頁面左上角，就能回上一層",Xt=5,ro=te({__name:"[reportId]",setup(P){const m=Je(),s=v(()=>Number.parseInt(m.params.reportId)),{report:I,reportFieldList:k,isDataReady:N,meta:x}=at(s.value),h=v(()=>Number.parseInt(m.query.fieldId)),d=v(()=>k.value.find(F=>F.id===h.value)||k.value[0]),y=$e();function w(i){Object.keys(i).forEach(O=>{d.value[O]=i[O]});const F=l.value===me?8e3:4e3;y.add({type:"success",duration:F,text:l.value})}const S=v(()=>x(d.value)),l=v(()=>{const i=k.value.filter(D=>!!D.value).length,F=k.value.length,O=F-i;return O?O<=Xt?`最後 ${O} 個欄位！ 🧙`:`已完成 ${i} / ${F} 個欄位 🤖`:me}),M=p({page:1,highlight:""}),E=p([]),R=p(0);function o(i){R.value=i}function _(i){M.value=i}function n(i){E.value=i}const L=Qe(),z=v(()=>k.value.findIndex(i=>i.id===h.value));function V(){let i=z.value+1;i===k.value.length&&(i=0),L.push({name:"profession-editor-reportId",params:{reportId:s.value},query:{fieldId:k.value[i].id}})}function g(){let i=z.value-1;i<0&&(i=k.value.length-1),L.push({name:"profession-editor-reportId",params:{reportId:s.value},query:{fieldId:k.value[i].id}})}function T(){window.location.reload()}return(i,F)=>{const O=Vt,D=qt;return a(N)?(f(),b("div",Jt,[X(O,{class:"editor__control br b--moon-gray",report:a(I),"report-field":a(d),"field-meta":a(S),"focused-page":a(R),onPage:_,onMatchedPages:n,onNext:V,onPrev:g,onReportField:w},null,8,["report","report-field","field-meta","focused-page"]),t("div",Qt,[a(M)?(f(),ce(D,{key:0,year:a(I).year,report:a(I),page:a(M).page,highlight:a(M).highlight,"matched-pages":a(E),onViewPage:o,onReload:T},null,8,["year","report","page","highlight","matched-pages"])):B("",!0)])])):B("",!0)}}});export{ro as default};
