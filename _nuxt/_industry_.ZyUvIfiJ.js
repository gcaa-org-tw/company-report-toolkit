import{_ as E}from"./FieldProgress.JlPNkdjX.js";import{_ as j}from"./nuxt-link.08g_xJuG.js";import{f as M,g as b,o as e,c as t,h as i,F as v,t as _,i as k,r as L,K as z,y as K,d as R,a,x as w,b as D,w as q,I as U,p as G,e as J,_ as Q,H as W,m as X,u as Z,A as T,B as Y}from"./entry.G35hZjvh.js";import{u as B,r as ee}from"./useProfessionApi.FpVhGREC.js";import{u as te}from"./useFieldMeta.leRCFToq.js";import{d as H}from"./dayjs.min.eH-gYEuC.js";import{m as se}from"./industryStats.nxyUZMo3.js";import{_ as ie}from"./lodash.l4Wf6ZdU.js";const re={class:"cellValue"},ne={key:0,class:"moon-gray"},oe={key:0,class:"cellValue__value"},ae={key:1,class:"f6 gray"},le=M({__name:"IndustryCellValue",props:{reportField:{},filedMeta:{}},setup(o){const c=o,u=b(()=>!c.reportField||!c.reportField.value&&!c.reportField.notes);return(d,n)=>(e(),t("div",re,[i(u)?(e(),t("div",ne,"尚未判讀")):(e(),t(v,{key:1},[d.reportField.value?(e(),t("div",oe,_(d.reportField.value)+" "+_(d.reportField.unit),1)):k("",!0),d.reportField.notes?(e(),t("div",ae,_(d.reportField.notes),1)):k("",!0)],64))]))}}),N=o=>(G("data-v-010fc0ed"),o=o(),J(),o),ce={class:"industryDetail"},de={key:0,class:"mv5 tc f2"},_e={class:"fw7"},ue=N(()=>a("div",{class:"industryDetail__cell industryDetail__cell--head industryDetail__cell--name"},"公司名稱",-1)),pe=N(()=>a("div",{class:"industryDetail__cell industryDetail__cell--head"},"更新時間",-1)),ye={key:0,class:"industryDetail__cell industryDetail__cell--head"},fe={key:0},me=N(()=>a("i",{class:"ml2 fa-solid fa-arrow-up-right-from-square"},null,-1)),ve={class:"industryDetail__value"},he={class:"industryDetail__cell"},ge={key:0,class:"industryDetail__cell"},ke=["onClick"],$e=M({__name:"IndustryDetail",props:{industry:{},year:{},reportList:{}},setup(o){const c=o,{feathers:u,isAdmin:d}=B(),n=L({}),{fieldMetaList:g}=te(),f=L(0),I=b(()=>{let r=`6rem repeat(${g.value.length}, 6rem) 8rem`;return d.value&&(r+=" 10rem"),{gridTemplateColumns:r}});function h(r){return H(r).format("YYYY/MM/DD HH:mm")}function P(r){return`/profession/report/${r.id}`}const C=z();async function F(r){confirm(`確定要將「${r.company.name} 」標為已驗證嗎？按下去之後，整本報告書就無法修改囉～～～`)&&(await u.app.service("report").patch(r.id,{isVerified:!0}),C.add({type:"success",text:`${r.company.name}驗證完畢`}),r.isVerified=!0)}function S(r,l=0){return u.app.service("report-field").find({query:{reportId:{$in:r},$limit:200,$skip:l}})}async function x(){const r=c.reportList.map(y=>y.id);let l=0;for(;;){const y=await S(r,l);if(y.data.forEach(m=>{n.value[m.reportId]||(n.value[m.reportId]={}),n.value[m.reportId][m.fieldId]=m}),!y.data.length){f.value=100;break}l=y.skip+y.data.length,f.value=Math.floor(l*100/y.total)}}async function A(){await x()}K(()=>c.reportList,A,{immediate:!0});async function p(){const r=c.reportList.map(s=>s.id),l=`${c.industry}-${c.year}.csv`,y=await u.app.service(ee).download({reportIds:r,fileName:l}),m=`${u.apiEndpoint.value}file/${y.id}`;window.open(m)}return(r,l)=>{const y=j,m=le;return e(),t("div",ce,[i(f)<100?(e(),t("h1",de,[R(" 資料載入中... "),a("span",_e,_(i(f))+"%",1)])):(e(),t(v,{key:1},[a("div",{class:"flex justify-end"},[a("button",{class:"bg-green pv2 ph3 ba white b--light-gray br2 dim pointer",onClick:p},"匯出表格")]),a("div",{class:"industryDetail__table mv3 f6",style:U(i(I))},[ue,(e(!0),t(v,null,w(i(g),s=>(e(),t("div",{key:s.id,class:"industryDetail__cell industryDetail__cell--head"},_(s.name),1))),128)),pe,i(d)?(e(),t("div",ye)):k("",!0),(e(!0),t(v,null,w(r.reportList,s=>(e(),t(v,{key:s.id},[i(n)[s.id]?(e(),t(v,{key:0},[D(y,{to:P(s),class:"industryDetail__cell industryDetail__cell--name gray dim no-underline"},{default:q(()=>[s.isVerified?(e(),t("span",fe,"✅")):k("",!0),R(" "+_(s.company.abbreviation)+" ",1),me]),_:2},1032,["to"]),(e(!0),t(v,null,w(i(g),$=>(e(),t("div",{key:$.id,class:"industryDetail__cell"},[a("div",ve,[D(m,{"report-field":i(n)[s.id][$.id],"filed-meta":$},null,8,["report-field","filed-meta"])])]))),128)),a("div",he,_(h(s.updatedAt)),1),i(d)?(e(),t("div",ge,[s.isVerified?k("",!0):(e(),t("button",{key:0,class:"bg-green white pv1 ph2 br2 bw0 dim pointer",onClick:$=>F(s)}," 標為已驗證 ✅ ",8,ke))])):k("",!0)],64)):k("",!0)],64))),128))],4)],64))])}}}),be=Q($e,[["__scopeId","data-v-010fc0ed"]]),we={class:"reportList"},Le=X('<div class="reportList__report"><div class="reportList__cell">公司名稱</div><div class="reportList__cell">年份</div><div class="reportList__cell">進度</div><div class="reportList__cell">更新時間</div></div>',1),De={class:"reportList__cell"},Ie={class:"reportList__cell"},Ce={class:"reportList__cell"},Fe={class:"reportList__cell"},Ve=a("i",{class:"fa-solid fa-arrow-right self-center"},null,-1),xe={key:1,class:"pa2 tc"},Ye=M({__name:"ReportList",props:{reportList:{},filter:{}},setup(o){const c=o,u=b(()=>c.filter===V.all?c.reportList:c.reportList.filter(n=>c.filter===V.verified?n.isVerified:c.filter===V.isAnswered?n.answeredFields===n.totalFields:n.answeredFields<n.totalFields));function d(n){return H(n).format("YYYY/MM/DD HH:mm")}return(n,g)=>{const f=E,I=j;return e(),t("div",we,[Le,i(u).length?(e(!0),t(v,{key:0},w(i(u),h=>(e(),W(I,{key:h.id,to:`/profession/report/${h.id}`,class:"reportList__report black dim no-underline"},{default:q(()=>[a("div",De,_(h.company.name),1),a("div",Ie,_(h.year),1),a("div",Ce,[D(f,{progress:h,"is-industry":!1},null,8,["progress"])]),a("div",Fe,_(d(h.updatedAt)),1),Ve]),_:2},1032,["to"]))),128)):(e(),t("div",xe," 此分類無 資料 "))])}}}),Me={class:"pb3"},Pe={class:"tc f2 fw6 mb2"},Se={class:"tc f3 mv2"},Ae={class:"w5 center"},Ne={class:"pv3 mb4 bt bb b--moon-gray flex justify-between"},Re={key:0},Ee=["onClick"],je={key:1},qe=["onClick"],Be={class:"industry__modeList"},He=["onClick"],Oe={key:0},ze={key:1,class:"pa4"};var V=(o=>(o.all="全部",o.verified="已驗證",o.isAnswered="判讀完成",o.pending="待判讀",o))(V||{}),O=(o=>(o.list="報告書列表",o.detail="所有欄位資料",o))(O||{});const Te=M({__name:"[industry]",setup(o){const u=Z().params.industry,{feathers:d}=B(),n=L([]),g=L("全部"),f=L(0),I=b(()=>ie.uniq(n.value.map(p=>p.year)));function h(p){f.value=p}const P=b(()=>n.value.filter(p=>p.year===f.value)),C=L("報告書列表"),F=b(()=>C.value==="所有欄位資料");function S(p){g.value=p}const x=b(()=>{const p={};return n.value.forEach(r=>{se(p,r)}),p[u]});async function A(){const r=(await d.app.service("company").find({query:{industry:u,$select:["id"],$limit:500}})).data.map(l=>l.id);d.app.service("report").find({query:{companyId:{$in:r},$limit:500,$sort:{year:-1}}}).then(l=>{n.value=l.data,l.data.length&&(f.value=l.data[0].year)})}return T(()=>{d.isReady.value&&A()}),(p,r)=>{const l=E,y=be,m=Ye;return i(n).length?(e(),t("div",{key:0,class:Y(["industry pa4 lh-copy",{"industry--wide":i(F)}])},[a("div",Me,[a("h1",Pe,_(i(u)),1),a("p",Se,_(i(x).total)+" 本",1),a("div",Ae,[D(l,{progress:i(x)},null,8,["progress"])])]),a("div",Ne,[i(F)?(e(),t("div",Re,[(e(!0),t(v,null,w(i(I),s=>(e(),t("button",{class:Y(["industry__filter bg-white pv2 ph3 ba b--light-gray br2 dim pointer",{"bg-green":i(f)===s}]),key:s,onClick:$=>h(s)},_(s),11,Ee))),128))])):(e(),t("div",je,[(e(!0),t(v,null,w(Object.values(V),s=>(e(),t("button",{class:Y(["industry__filter bg-white pv2 ph3 ba b--light-gray br2 dim pointer",{"bg-green":i(g)===s}]),key:s,onClick:$=>S(s)},_(s),11,qe))),128))])),a("div",Be,[(e(!0),t(v,null,w(Object.values(O),s=>(e(),t("button",{class:Y(["industry__mode bg-white pv2 ph3 ba b--light-gray br2 dim pointer",{"industry__mode--active":i(C)===s}]),key:s,onClick:$=>C.value=s},_(s),11,He))),128))])]),i(F)?(e(),t("div",Oe,[D(y,{"report-list":i(P),industry:i(u),year:i(f)},null,8,["report-list","industry","year"])])):(e(),t("div",ze,[D(m,{"report-list":i(n),filter:i(g)},null,8,["report-list","filter"])]))],2)):k("",!0)}}});export{V as FilterType,Te as default};
