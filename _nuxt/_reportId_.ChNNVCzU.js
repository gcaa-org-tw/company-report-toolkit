import{_ as Ge}from"./nuxt-link.g4mfOmOW.js";import{f as ee,r as h,g as y,A as he,y as X,o as i,c as f,a as t,F,x as re,B as le,h as o,t as A,n as Y,v as we,q as ye,C as Pe,l as Ue,z as ie,_ as te,b as Q,w as We,d as M,i as H,p as ke,e as $e,K as Se,D as ae,k as qe,E as Je,G as Qe,H as ce,I as ge,J as Xe,u as Ye,L as Ze}from"./entry.Y_R2Bi7N.js";import{_ as Z,a as et}from"./lodash.h9Ugf_Co.js";import{a as tt,_ as ot,b as at}from"./SinglePdfPage.k5cs18q0.js";import{t as Ce,_ as st,a as nt}from"./AnswerPanel.vue.e8s2oqrE.js";import{u as Ie}from"./useProfessionApi.gpwTi3cx.js";import{u as rt}from"./vue.f36acd1f.95skVqGL.js";import{u as lt}from"./index.vdQ-sAme.js";import{u as it}from"./useReport.cmK78SuC.js";const ct={class:"searchPanel"},ut={class:"flex mt2"},dt={class:"flex flex-wrap"},pt=["onClick"],ft={class:"f6 dark-gray mv1"},_t=["onClick"],ht={class:"flex-none dark-gray"},gt=["innerHTML"],J=15,vt=ee({__name:"SearchPanel",props:{report:{},fieldMeta:{}},emits:["matched-pages","page"],setup(C,{emit:N}){const k=C,L=N,c=Ue(),u=tt(c.public.algoliaAppId,c.public.algoliaSearchApiKey).initIndex(c.public.algoliaIndexName),x=h(""),g=h(""),m=h([]),$=h(null),P=y(()=>g.value||x.value||"");he(()=>{k.fieldMeta.keywords.length&&(x.value=k.fieldMeta.keywords[0])}),X([x,g],([s,v],[a,V])=>{s!==a&&s?g.value="":v!==V&&v&&(x.value="")});function I(s){x.value=s}he(()=>{P.value&&n()});async function n(){if(!P.value){m.value=[],$.value=null;return}const{hits:s}=await u.search(P.value,{facetFilters:[`company:${k.report.company.id}`,`year:${k.report.year}`],hitsPerPage:100});m.value=s.filter(v=>v.page<=k.report.totalPages),$.value=null}X(m,s=>{const v=s.map(a=>a.page);L("matched-pages",v)});function R(s){s=s.replace(/\n/g,"");const v=`${P.value||""}`,a=s.indexOf(v),V=v.length+J;if(a<0)return s.slice(0,V*2);const z=v.length;let j=s.slice(0,a);const B=`${s.slice(a+z,a+z+J)}...`;if(a>J)j=`...${s.slice(a-J,a)}`;else return s.slice(0,V*2)+"...";return`${Z.escape(j)}<b class="underline">${v}</b>${Z.escape(B)}`}async function E(s){$.value===s?L("page",{highlight:"",page:1}):$.value=s,await ie(),L("page",{highlight:P.value,page:s.page})}function T(s){return Ce(s,k.report)}return(s,v)=>(i(),f("div",ct,[t("div",ut,[t("div",dt,[(i(!0),f(F,null,re(s.fieldMeta.keywords,a=>(i(),f("button",{class:le(["searchPanel__keyword pointer ba b--moon-gray br1",{"searchPanel__keyword--active":a===o(P)}]),key:a,onClick:V=>I(a)},A(a),11,pt))),128)),Y(t("input",{class:"mt1 f6 w-100 searchPanel__input","onUpdate:modelValue":v[0]||(v[0]=a=>ye(g)?g.value=a:null),placeholder:"自訂關鍵字"},null,512),[[we,o(g),void 0,{trim:!0}]])])]),Y(t("div",ft,[(i(!0),f(F,null,re(o(m),a=>(i(),f("div",{class:le(["flex mv2 dim pointer",{b:a===o($)}]),key:a.page,onClick:V=>E(a)},[t("div",ht,"頁"+A(T(a.page)),1),t("div",{class:"pl2",innerHTML:R(a.content)},null,8,gt)],10,_t))),128))],512),[[Pe,o(m).length]])]))}}),mt=te(vt,[["__scopeId","data-v-f86955e2"]]),bt=te(st,[["__scopeId","data-v-879df1be"]]),W=C=>(ke("data-v-aaa39382"),C=C(),$e(),C),wt={class:"editorControl"},yt={class:"ph3"},Pt=W(()=>t("i",{class:"fa-solid fa-arrow-left mr1"},null,-1)),kt={class:"editorControl__keepTop mt2 pv2 ph3 mb2 bb b--moon-gray"},$t={class:"fw6 f4 mv0 black"},St={class:"ph3"},Ct={class:"gray f6 mt0 pb2 mb3 bb b--moon-gray lh-copy"},It={class:"editorControl__keywordSection pb2 mb3"},xt=W(()=>t("div",{class:"editorControl__keepMiddle fw5 mb1"},"相關關鍵字",-1)),Mt=W(()=>t("div",{class:"f6 gray"},"點選以下關鍵字，或是自行輸入，就能搜出相關頁面",-1)),Lt={key:0,class:"editorControl__keepBottom pv2 ph3 bt ba b--moon-gray shadow-1 br2"},Vt={class:"flex justify-end"},Et=W(()=>t("i",{class:"fa-solid fa-eye ml2 f7"},null,-1)),Tt=W(()=>t("i",{class:"fa-solid fa-eye-slash ml2 f7"},null,-1)),Ft={class:"mt2"},Nt=ee({__name:"EditorControl",props:{report:{},reportField:{},fieldMeta:{},focusedPage:{}},emits:["page","matched-pages","next","prev","report-field"],setup(C,{emit:N}){const{isCollaborator:k}=Ie(),L=C,c=N,O=y(()=>({name:"profession-report-reportId",params:{reportId:L.report.id}}));function u(n){c("matched-pages",n)}function x(n){c("page",n)}const g=h(!1);function m(){g.value=!g.value}function $(n){c("report-field",n),P()}function P(){c("next")}function I(){c("prev")}return(n,R)=>{const E=Ge,T=mt,s=bt;return i(),f("div",wt,[t("div",yt,[Q(E,{class:"flex f6 gray items-center no-underline dim pt3",to:o(O)},{default:We(()=>[Pt,M(A(n.report.company.abbreviation)+" "+A(n.report.year)+" 報告書",1)]),_:1},8,["to"])]),t("div",kt,[t("h1",$t,A(n.fieldMeta.name),1)]),t("div",St,[t("p",Ct,A(n.fieldMeta.description),1),t("div",{class:"flex justify-between items-center mb3 mt2 pb3 bb b--moon-gray"},[t("button",{class:"editorControl__nav",onClick:I},"往上個欄位"),t("button",{class:"editorControl__nav",onClick:P},"往下個欄位")]),t("div",It,[xt,Mt,Q(T,{report:n.report,"field-meta":n.fieldMeta,onMatchedPages:u,onPage:x},null,8,["report","field-meta"])])]),o(k)?(i(),f("div",Lt,[t("div",Vt,[t("button",{class:"pv2 ph3 ba bg-dark-gray white br2 pointer f6 flex items-baseline",onClick:m},[o(g)?(i(),f(F,{key:0},[M("展開填答 x 驗證區"),Et],64)):(i(),f(F,{key:1},[M("收合填答 x 驗證區"),Tt],64))])]),Y(t("div",Ft,[Q(s,{report:n.report,"report-field":n.reportField,"field-meta":n.fieldMeta,"focused-page":n.focusedPage,onNext:$},null,8,["report","report-field","field-meta","focused-page"])],512),[[Pe,!o(g)]])])):H("",!0)])}}}),Ot=te(Nt,[["__scopeId","data-v-aaa39382"]]),oe=C=>(ke("data-v-6bc90ced"),C=C(),$e(),C),Rt={class:"reportViewer"},At={class:"reportViewer__control pr2"},Ht={class:"bb b--moon-gray flex items-center justify-between pv2"},zt={class:"flex items-center pl3"},jt=oe(()=>t("i",{class:"fa-solid fa-plus"},null,-1)),Bt=oe(()=>t("i",{class:"fa-solid fa-minus"},null,-1)),Kt=oe(()=>t("i",{class:"fa-solid fa-arrows-left-right"},null,-1)),Dt=oe(()=>t("i",{class:"fa-solid fa-arrows-up-down"},null,-1)),Gt={key:0,class:"reportViewer__content w-100"},Ut={class:"flex flex-column items-center justify-center h-100 f3 fw6 flex-auto"},Wt=["onClick"],qt={key:0,class:"flex flex-column items-center justify-center h-100 f3 fw6 flex-auto"},Jt=["onClick"],se="https://cdn.jsdelivr.net/npm/pdfjs-dist@3.9.179",Qt="https://gcaa-static.s3.ap-northeast-3.amazonaws.com/company-report-toolkit",ne=10,Xt=100,Yt=60,ve=.1,me=100,Zt=ee({__name:"PdfViewer",props:{page:{default:1},year:{default:2019},report:{},highlight:{default:""},matchedPages:{default(){return[]}}},emits:["view-page","page","reload"],setup(C,{emit:N}){const k=Se(),{feathers:L,isCollaborator:c}=Ie();rt({link:[{rel:"stylesheet",href:`${se}/web/pdf_viewer.css`}]});const O=N,u=C,x=h(!1),g=h(void 0),m=h([]),$=h(0),P=ae({}),I=h([null]),n=h(!1);function R(){n.value=!n.value}const E=h(1),T=h(1),s=y({get(){return Ce(T.value,u.report)},set(e){const r=nt(Number.parseInt(e,10),u.report);Re(r)}}),v=y(()=>{let e=u.report.pageOffset||0,r=u.report.totalPages;return u.report.is2Pages&&(r=r*2-1),e&&(r+=e,e=Math.abs(e)),`${r} + ${Math.abs(e)}`}),a=h(!1);function V(){u.report.hasSetPageOffset||!c.value?a.value=!1:(a.value=!0,k.add({type:"warning",text:"歡迎光臨，我們先校正報告書的第一頁吧 🍥",duration:5e3}))}const z=()=>{a.value=!a.value},j=y(()=>a.value?"取消設定報告第一頁":"頁次對不上？點此調整");async function B(e,r){n.value&&e>1&&(e=(e-1)*2+(r?0:1));const d=1-e;try{await L.app.service("report").patch(u.report.id,{pageOffset:d,is2Pages:n.value}),O("reload"),a.value=!1}catch(w){throw w.message&&k.add({type:"error",text:w.message}),w}}const l=h("fit-width"),p=h({pdfSize:{width:0,height:0},widthScale:0,heightScale:0,customScale:0}),b=y(()=>{if(!p.value.widthScale||!fe.value)return null;let e=1;switch(l.value){case"custom":e=p.value.customScale;break;case"fit-height":e=p.value.heightScale;break;case"fit-width":default:e=p.value.widthScale}return e=e||1,{scale:e,width:p.value.pdfSize.width*e,height:p.value.pdfSize.height*e}});qe(()=>{de()}),Je(()=>{clearTimeout(g.value)});const D=y(()=>I.value[0]&&b.value),ue=y(()=>`${Qt}/${u.year}/${u.report.company.id}`),xe=y(()=>u.highlight+"");function Me(){return!!window&&!!window.pdfjsLib&&!!window.pdfjsViewer}function de(){g.value=setTimeout(async()=>{const e=Me();e?(window.pdfjsLib.GlobalWorkerOptions.workerSrc=`${se}/build/pdf.worker.js`,await ie()):de(),x.value=e},Xt)}async function pe(e){const r=window.pdfjsLib,d=`${se}/cmaps/`,w=e%ne||ne,_=Fe(e);P.value[_]||(P.value[_]=r.getDocument({url:`${ue.value}/${_}.pdf`,cMapUrl:d,cMapPacked:!0,enableXfa:!0}));const S=await P.value[_].promise;return Le(S),{document:S,page:w}}async function Le(e){if(p.value.widthScale)return;const r=await e.getPage(1),{width:d,height:w}=r.getViewport({scale:1});p.value.pdfSize={width:d,height:w};const _=K.value,S=_.clientWidth,U=_.clientHeight,Ke=Number.parseInt(getComputedStyle(_).paddingLeft),De=S-Ke*2;p.value.widthScale=De/d,p.value.heightScale=U/w}const q=y(()=>{var e,r;return b.value?{width:`${(e=b.value)==null?void 0:e.width}px`,height:`${(r=b.value)==null?void 0:r.height}px`}:{}}),Ve=y(()=>q.value.height?{...q.value,marginTop:`-${q.value.height}`}:{});async function Ee(){const e=await pe(1);I.value[0]={pdf:ae(e)}}function Te(){P.value={},I.value=Array(u.report.totalPages).fill(null),l.value="fit-width",p.value.widthScale=0}function Fe(e){return`${Math.ceil(e/ne)}`.padStart(3,"0")}async function G(e,{forceLoad:r=!1,anchor:d=0}={}){if(!r&&m.value.length){m.value.includes(e)||m.value.unshift(e);return}const w=e-1;if(w>=I.value.length)throw new Error(`Invalid page number: ${e}`);if(r||(m.value.push(e),d&&($.value=d)),!I.value[w]){const _=await pe(e);I.value[w]={pdf:ae(_),highlight:u.matchedPages.includes(e)?xe.value:""}}m.value.pop(),m.value.length?G(m.value[0],{forceLoad:!0}):setTimeout(()=>{$.value=0},me)}const Ne=Z.debounce(e=>{G(e)},100),fe=lt(),K=h(null);et(()=>ue.value&&!x.value&&!fe.value,()=>{Te(),Ee(),V()});function Oe(e){const d=K.value.querySelectorAll(".reportViewer__page")[e-1];return d==null?void 0:d.offsetTop}function Re(e){e<1||e>u.report.totalPages||Number.isNaN(e)||(_e(e),O("page",e))}async function _e(e){e=Math.floor(e);const r=Oe(e),d=G(e,{anchor:r});e>1&&G(e-1),e<u.report.totalPages&&G(e+1),r&&K.value.scrollTo({top:r}),await d,T.value=e}X(()=>u.page,async()=>{await _e(u.page)});function Ae(){var e;p.value.customScale=(((e=b.value)==null?void 0:e.scale)||1)*(1+ve),l.value="custom"}function He(){var e;p.value.customScale=(((e=b.value)==null?void 0:e.scale)||1)*(1-ve),l.value="custom"}function ze(){l.value="fit-width"}function je(){l.value="fit-height"}X(b,async(e,r)=>{if(!e||!r||!K.value)return;const d=K.value,w=d.clientHeight/2,_=(d.scrollTop+w)/d.scrollHeight;await ie();const S=d.scrollHeight*_-w;$.value=S,setTimeout(()=>{$.value=0},me)});const Be=Z.debounce(e=>{e!==E.value&&(T.value=E.value,E.value=e,O("view-page",T.value))},Yt);return(e,r)=>{const d=ot,w=at;return i(),f("div",Rt,[t("div",At,[t("div",Ht,[t("div",zt,[Y(t("input",{class:"reportViewer__pageInput b--moon-gray ba ph1 mr1","onUpdate:modelValue":r[0]||(r[0]=_=>ye(s)?s.value=_:null),onKeyup:r[1]||(r[1]=Qe(_=>_.target.blur(),["enter"]))},null,544),[[we,o(s),void 0,{lazy:!0}]]),M("頁 / 共 "+A(o(v))+" 頁",1),o(c)?(i(),f("button",{key:0,class:"reportViewer__button ml2 gray",onClick:z},A(o(j)),1)):H("",!0)]),t("div",{class:"flex items-center"},[t("button",{class:"reportViewer__button",onClick:Ae},[jt,M("放大")]),t("button",{class:"reportViewer__button",onClick:He},[Bt,M("縮小")]),t("button",{class:"reportViewer__button",onClick:ze},[Kt,M("滿頁寬")]),t("button",{class:"reportViewer__button",onClick:je},[Dt,M("滿頁高")])])])]),t("div",{class:"reportViewer__scrollContainer relative",ref_key:"scrollerEle",ref:K},[o(D)?(i(),f("div",Gt,[(i(!0),f(F,null,re(o(I),(_,S)=>(i(),f(F,{key:S},[_?(i(),ce(w,Xe({key:1,class:"reportViewer__page"},_.pdf,{class:[`thePage--${S+1}`],highlight:_.highlight,"page-anchor":o($),scale:o(b).scale,onVisible:U=>o(Be)(S+1)}),null,16,["class","highlight","page-anchor","scale","onVisible"])):(i(),ce(d,{key:0,class:le(["reportViewer__page",[`theEmpty--${S+1}`]]),style:ge(o(q)),"page-number":S+1,onVisible:U=>o(Ne)(S+1)},null,8,["style","class","page-number","onVisible"])),o(a)?(i(),f("div",{key:2,class:"reportViewer__page reportViewer__page--mask center pointer flex",style:ge(o(Ve))},[t("div",Ut,[t("div",{class:"reportViewer__maskLabel pv3 ph4 br2 mb3",onClick:R},[o(n)?(i(),f(F,{key:0},[M("切換為單頁模式")],64)):(i(),f(F,{key:1},[M("切換為雙頁模式")],64))]),t("div",{class:"reportViewer__maskLabel pv3 ph4 br2",onClick:U=>B(S+1,!0)},"設定為第一頁",8,Wt)]),o(n)?(i(),f("div",qt,[t("div",{class:"reportViewer__maskLabel pv3 ph4 br2 mb3",onClick:R},[o(n)?(i(),f(F,{key:0},[M("切換為單頁模式")],64)):(i(),f(F,{key:1},[M("切換為雙頁模式")],64))]),t("div",{class:"reportViewer__maskLabel pv3 ph4 br2",onClick:U=>B(S+1,!1)},"設定為第一頁",8,Jt)])):H("",!0)],4)):H("",!0)],64))),128))])):H("",!0)],512)])}}}),eo=te(Zt,[["__scopeId","data-v-6bc90ced"]]),to={key:0,class:"editor"},oo={class:"editor__viewer"},be="看完收工！ 🎉 找找頁面左上角，就能回上一層",ao=5,_o=ee({__name:"[reportId]",setup(C){const N=Ye(),k=y(()=>Number.parseInt(N.params.reportId)),{report:L,reportFieldList:c,isDataReady:O,meta:u}=it(k.value),x=y(()=>Number.parseInt(N.query.fieldId)),g=y(()=>c.value.find(p=>p.id===x.value)||c.value[0]),m=Se();function $(l){Object.keys(l).forEach(b=>{g.value[b]=l[b]});const p=I.value===be?8e3:4e3;m.add({type:"success",duration:p,text:I.value})}const P=y(()=>u(g.value)),I=y(()=>{const l=c.value.filter(D=>!!D.value).length,p=c.value.length,b=p-l;return b?b<=ao?`最後 ${b} 個欄位！ 🧙`:`已完成 ${l} / ${p} 個欄位 🤖`:be}),n=h({page:1,highlight:""}),R=h([]),E=h(0);function T(l){E.value=l}function s(l){n.value=l}function v(l){R.value=l}const a=Ze(),V=y(()=>c.value.findIndex(l=>l.id===x.value));function z(){let l=V.value+1;l===c.value.length&&(l=0),a.push({name:"profession-editor-reportId",params:{reportId:k.value},query:{fieldId:c.value[l].id}})}function j(){let l=V.value-1;l<0&&(l=c.value.length-1),a.push({name:"profession-editor-reportId",params:{reportId:k.value},query:{fieldId:c.value[l].id}})}function B(){window.location.reload()}return(l,p)=>{const b=Ot,D=eo;return o(O)?(i(),f("div",to,[Q(b,{class:"editor__control br b--moon-gray",report:o(L),"report-field":o(g),"field-meta":o(P),"focused-page":o(E),onPage:s,onMatchedPages:v,onNext:z,onPrev:j,onReportField:$},null,8,["report","report-field","field-meta","focused-page"]),t("div",oo,[o(n)?(i(),ce(D,{key:0,year:o(L).year,report:o(L),page:o(n).page,highlight:o(n).highlight,"matched-pages":o(R),onViewPage:T,onReload:B},null,8,["year","report","page","highlight","matched-pages"])):H("",!0)])])):H("",!0)}}});export{_o as default};
