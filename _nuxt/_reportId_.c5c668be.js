import{_ as Re}from"./nuxt-link.c434ce61.js";import{f as B,r as w,h as b,B as Q,z as X,o as p,c as y,a as t,F as O,y as Z,C as re,i as a,t as F,q as T,v as ue,s as be,D as de,m as Oe,A as ie,_ as te,L as He,M as he,d as V,N as Ue,x as je,p as pe,e as _e,b as Y,w as ze,u as Be,E as ae,l as De,G as Ke,H as Ge,I as ce,J as ge,K as We,j as ee,g as qe,O as Je}from"./entry.1190f0bf.js";import{a as Ye,_ as z,u as Qe,b as Xe,c as Ze}from"./SinglePdfPage.9d939236.js";import{u as ye}from"./useProfessionApi.61e1bf6a.js";import{u as et}from"./useReport.d4716e35.js";import"./_commonjsHelpers.5298ce9e.js";const tt={class:"searchPanel"},ot={class:"flex mt2"},at={class:"flex flex-wrap"},nt=["onClick"],st={class:"f6 dark-gray mv1"},lt=["onClick"],rt={class:"flex-none dark-gray"},it=["innerHTML"],J=15,ct=B({__name:"SearchPanel",props:{report:{},fieldMeta:{}},emits:["matched-pages","page"],setup(_,{emit:P}){const l=_,I=Oe(),L=Ye(I.public.algoliaAppId,I.public.algoliaSearchApiKey).initIndex(I.public.algoliaIndexName),d=w(""),g=w(""),m=w([]),f=w(null),$=b(()=>g.value||d.value||"");Q(()=>{l.fieldMeta.keywords.length&&(d.value=l.fieldMeta.keywords[0])}),X([d,g],([o,i],[n,E])=>{o!==n&&o?g.value="":i!==E&&i&&(d.value="")});function r(o){d.value=o}Q(()=>{$.value&&M()});async function M(){if(!$.value){m.value=[],f.value=null;return}const{hits:o}=await L.search($.value,{facetFilters:[`company:${l.report.company.id}`,`year:${l.report.year}`],hitsPerPage:100});m.value=o,f.value=null}X(m,o=>{const i=o.map(n=>n.page);P("matched-pages",i)});function N(o){o=o.replace(/\n/g,"");const i=`${$.value||""}`,n=o.indexOf(i),E=i.length+J;if(n<0)return o.slice(0,E*2);const R=i.length;let H=o.slice(0,n);const u=`${o.slice(n+R,n+R+J)}...`;if(n>J)H=`...${o.slice(n-J,n)}`;else return o.slice(0,E*2)+"...";return`${z.escape(H)}<b class="underline">${i}</b>${z.escape(u)}`}async function k(o){f.value===o?P("page",{highlight:"",page:1}):f.value=o,await ie(),P("page",{highlight:$.value,page:o.page})}function S(o){return o+(l.report.company.pageOffset||0)}return(o,i)=>(p(),y("div",tt,[t("div",ot,[t("div",at,[(p(!0),y(O,null,Z(o.fieldMeta.keywords,n=>(p(),y("button",{class:re(["searchPanel__keyword pointer ba b--moon-gray br1",{"searchPanel__keyword--active":n===a($)}]),key:n,onClick:E=>r(n)},F(n),11,nt))),128)),T(t("input",{class:"mt1 f6 w-100 searchPanel__input","onUpdate:modelValue":i[0]||(i[0]=n=>be(g)?g.value=n:null),placeholder:"自訂關鍵字"},null,512),[[ue,a(g),void 0,{trim:!0}]])])]),T(t("div",st,[(p(!0),y(O,null,Z(a(m),n=>(p(),y("div",{class:re(["flex mv2 dim pointer",{b:n===a(f)}]),key:n.page,onClick:E=>k(n)},[t("div",rt,"頁"+F(S(n.page)),1),t("div",{class:"pl2",innerHTML:N(n.content)},null,8,it)],10,lt))),128))],512),[[de,a(m).length]])]))}});const ut=te(ct,[["__scopeId","data-v-acd48ea5"]]),dt=_=>(pe("data-v-35973489"),_=_(),_e(),_),pt={class:"answerPanel"},_t=["onSubmit"],ft={class:"fw5 mb2"},vt={class:"flex items-center mb2"},ht={class:"answerPanel__value flex-auto mr3"},gt=dt(()=>t("span",{class:"f6 mid-gray"}," 數值 ",-1)),mt=["type"],wt={key:1,class:"answerPanel__input pv2"},bt={class:"mr2"},yt={class:"answerPanel__unit flex-none"},Pt=["value"],$t={class:"flex mb2"},St={class:"flex justify-between"},kt=["disabled"],ne="NA",xt=B({__name:"AnswerPanel",props:{report:{},reportField:{},fieldMeta:{}},emits:["next"],setup(_,{emit:P}){const l=_,{feathers:I}=ye(),s=w({value:"",unit:"",notes:""}),L=b(()=>s.value.notes?!0:s.value.value&&(s.value.unit||!m.value)),d=b(()=>{let k="填寫判讀結果";return s.value.value===ne&&(k+=" (已標為無法填答)"),k}),g=new Set(["無",ne]),m=b(()=>l.fieldMeta.units?l.fieldMeta.units.some(k=>!g.has(k)):!1),f={number:"number",string:"text",boolean:"radio"},$=b(()=>f[l.fieldMeta.dataType]||"text");Q(()=>{l.reportField&&(s.value.value=l.reportField.value||"",s.value.unit=l.reportField.unit||"",s.value.notes=l.reportField.notes||"")});async function r(k){await I.app.service("report-field").patch(l.reportField.id,k),P("next",k)}function M(){r({value:s.value.value.toString(),unit:s.value.unit,notes:s.value.notes})}function N(){r({value:ne,unit:"",notes:s.value.notes})}return(k,S)=>(p(),y("div",pt,[t("form",{class:"answerPanel__form pb2 bb b--moon-gray",onSubmit:je(M,["prevent"])},[t("div",ft,F(a(d)),1),t("div",vt,[t("div",ht,[gt,a($)!=="radio"?T((p(),y("input",{key:0,"onUpdate:modelValue":S[0]||(S[0]=o=>a(s).value=o),type:a($),class:"answerPanel__input",placeholder:"數值"},null,8,mt)),[[He,a(s).value,void 0,{trim:!0}]]):(p(),y("div",wt,[t("label",bt,[T(t("input",{"onUpdate:modelValue":S[1]||(S[1]=o=>a(s).value=o),type:"radio",name:"answerValue",value:"是"},null,512),[[he,a(s).value]]),V(" 是 ")]),t("label",null,[T(t("input",{"onUpdate:modelValue":S[2]||(S[2]=o=>a(s).value=o),type:"radio",name:"answerValue",value:"否"},null,512),[[he,a(s).value]]),V(" 否 ")])]))]),T(t("label",yt,[V(" 單位 "),T(t("select",{"onUpdate:modelValue":S[3]||(S[3]=o=>a(s).unit=o),name:"answerUnit",class:"answerPanel__input"},[(p(!0),y(O,null,Z(k.fieldMeta.units,o=>(p(),y("option",{key:o,value:o},F(o),9,Pt))),128))],512),[[Ue,a(s).unit]])],512),[[de,a(m)]])]),t("div",$t,[t("label",null,[V(" 備註 "),T(t("textarea",{"onUpdate:modelValue":S[4]||(S[4]=o=>a(s).notes=o),class:"answerPanel__input",placeholder:"備註"},null,512),[[ue,a(s).notes,void 0,{trim:!0}]])])]),t("div",St,[t("button",{type:"button",class:"answerPanel__submit",onClick:N},"無法填答"),t("button",{type:"submit",disabled:!a(L),class:"answerPanel__submit"},"儲存",8,kt)])],40,_t)]))}});const It=te(xt,[["__scopeId","data-v-35973489"]]),D=_=>(pe("data-v-c67538dc"),_=_(),_e(),_),Mt={class:"editorControl ph3"},Ct=D(()=>t("i",{class:"fa-solid fa-arrow-left mr1"},null,-1)),Vt={class:"editorControl__keepTop mt2 pv2 mb3 bb b--moon-gray"},Lt={class:"fw6 f4 mt0 mb2 black"},Et={class:"gray f6 mv0 lh-copy"},Tt={class:"editorControl__keywordSection pb2 mb3"},Ft=D(()=>t("div",{class:"editorControl__keepMiddle fw5 mb1"},"相關關鍵字",-1)),Nt=D(()=>t("div",{class:"f6 gray"},"點選以下關鍵字，或是自行輸入，就能搜出相關頁面",-1)),At={class:"editorControl__keepBottom pb3 pt2 bt b--moon-gray"},Rt={class:"flex justify-end"},Ot=D(()=>t("i",{class:"fa-solid fa-eye ml2 f7"},null,-1)),Ht=D(()=>t("i",{class:"fa-solid fa-eye-slash ml2 f7"},null,-1)),Ut=B({__name:"EditorControl",props:{report:{},reportField:{},fieldMeta:{}},emits:["page","matched-pages","next","prev","report-field"],setup(_,{emit:P}){const l=_,I=b(()=>({name:"profession-report-reportId",params:{reportId:l.report.id}}));function s(r){P("matched-pages",r)}function L(r){P("page",r)}const d=w(!1);function g(){d.value=!d.value}function m(r){P("report-field",r),f()}function f(){P("next")}function $(){P("prev")}return(r,M)=>{const N=Re,k=ut,S=It;return p(),y("div",Mt,[Y(N,{class:"flex f6 gray items-center no-underline dim pt3",to:a(I)},{default:ze(()=>[Ct,V(F(r.report.company.abbreviation)+" "+F(r.report.year)+" 報告書",1)]),_:1},8,["to"]),t("div",Vt,[t("h1",Lt,F(r.fieldMeta.name),1),t("p",Et,F(r.fieldMeta.description),1)]),t("div",{class:"flex justify-between items-center mb3 mt2 pb3 bb b--moon-gray"},[t("button",{class:"editorControl__nav",onClick:$},"往上個欄位"),t("button",{class:"editorControl__nav",onClick:f},"往下個欄位")]),t("div",Tt,[Ft,Nt,Y(k,{report:r.report,"field-meta":r.fieldMeta,onMatchedPages:s,onPage:L},null,8,["report","field-meta"])]),t("div",At,[t("div",Rt,[t("button",{class:"pv1 ph3 ba bg-white pointer f6 gray mb2 flex items-baseline",onClick:g},[a(d)?(p(),y(O,{key:0},[V("展開填答 x 驗證區"),Ot],64)):(p(),y(O,{key:1},[V("收合填答 x 驗證區"),Ht],64))])]),T(Y(S,{report:r.report,"report-field":r.reportField,"field-meta":r.fieldMeta,onNext:m},null,8,["report","report-field","field-meta"]),[[de,!a(d)]])])])}}});const jt=te(Ut,[["__scopeId","data-v-c67538dc"]]),K=_=>(pe("data-v-6132997c"),_=_(),_e(),_),zt={class:"reportViewer"},Bt={class:"reportViewer__control pr2"},Dt={class:"bb b--moon-gray flex items-center justify-between pv2"},Kt={class:"flex items-center pl3"},Gt=K(()=>t("i",{class:"fa-solid fa-plus"},null,-1)),Wt=K(()=>t("i",{class:"fa-solid fa-minus"},null,-1)),qt=K(()=>t("i",{class:"fa-solid fa-arrows-left-right"},null,-1)),Jt=K(()=>t("i",{class:"fa-solid fa-arrows-up-down"},null,-1)),Yt={key:0,class:"reportViewer__content w-100"},Qt=["onClick"],Xt=K(()=>t("div",{class:"flex items-center justify-center h-100 f3 fw6"},[t("div",{class:"reportViewer__maskLabel pv3 ph4 br2"},"設定為第一頁")],-1)),Zt=[Xt],se="https://cdn.jsdelivr.net/npm/pdfjs-dist@3.9.179",eo="https://gcaa-static.s3.ap-northeast-3.amazonaws.com/company-report-toolkit",le=10,to=100,oo=100,ao=2e3,me=.1,we=100,no=B({__name:"PdfViewer",props:{page:{default:1},year:{default:2019},report:{},highlight:{default:""},matchedPages:{default(){return[]}}},emits:["view-page","page","reload"],setup(_,{emit:P}){const l=_,{feathers:I}=ye();Be({link:[{rel:"stylesheet",href:`${se}/web/pdf_viewer.css`}]});const s=w(!1),L=w(void 0),d=w([]),g=w(0),m=ae({}),f=w([null]),$=w(1),r=b({get(){const e=$.value+(l.report.pageOffset||0);return e<1?"-":e},set(e){const c=Number.parseInt(e,10)-(l.report.pageOffset||0);Me(c)}}),M=w(!1),N=()=>{M.value=!M.value},k=b(()=>M.value?"取消設定報告第一頁":"頁次對不上？點此調整");async function S(e){const c=1-e;await I.app.service("report").patch(l.report.id,{pageOffset:c}),P("reload"),M.value=!1}const o=w("fit-width"),i=w({pdfSize:{width:0,height:0},widthScale:0,heightScale:0,customScale:0}),n=b(()=>{if(!i.value.widthScale||!fe.value)return null;let e=1;switch(o.value){case"custom":e=i.value.customScale;break;case"fit-height":e=i.value.heightScale;break;case"fit-width":default:e=i.value.widthScale}return e=e||1,{scale:e,width:i.value.pdfSize.width*e,height:i.value.pdfSize.height*e}});De(()=>{A()}),Ke(()=>{clearTimeout(L.value)});const E=b(()=>f.value[0]&&n.value),R=b(()=>`${eo}/${l.year}/${l.report.company.id}`),H=b(()=>l.highlight+"");function u(){return!!window&&!!window.pdfjsLib&&!!window.pdfjsViewer}function A(){L.value=setTimeout(async()=>{const e=u();e?(window.pdfjsLib.GlobalWorkerOptions.workerSrc=`${se}/build/pdf.worker.js`,await ie()):A(),s.value=e},to)}async function G(e){const c=window.pdfjsLib,v=`${se}/cmaps/`,C=e%le||le,h=ke(e);m.value[h]||(m.value[h]=c.getDocument({url:`${R.value}/${h}.pdf`,cMapUrl:v,cMapPacked:!0,enableXfa:!0}));const x=await m.value[h].promise;return oe(x),{document:x,page:C}}async function oe(e){if(i.value.widthScale)return;const c=await e.getPage(1),{width:v,height:C}=c.getViewport({scale:1});i.value.pdfSize={width:v,height:C};const h=U.value,x=h.clientWidth,q=h.clientHeight,Ne=Number.parseInt(getComputedStyle(h).paddingLeft),Ae=x-Ne*2;i.value.widthScale=Ae/v,i.value.heightScale=q/C}const W=b(()=>{var e,c;return n.value?{width:`${(e=n.value)==null?void 0:e.width}px`,height:`${(c=n.value)==null?void 0:c.height}px`}:{}}),Pe=b(()=>W.value.height?{...W.value,marginTop:`-${W.value.height}`}:{});async function $e(){const e=await G(1);f.value[0]={pdf:ae(e)}}function Se(){m.value={},f.value=Array(l.report.totalPages).fill(null),o.value="fit-width",i.value.widthScale=0}Q(()=>{!R.value||!s.value||!fe.value||(Se(),$e())});function ke(e){return`${Math.ceil(e/le)}`.padStart(3,"0")}async function j(e,{forceLoad:c=!1,anchor:v=0}={}){if(!c&&d.value.length){d.value.includes(e)||d.value.unshift(e);return}const C=e-1;if(C>=f.value.length)throw new Error(`Invalid page number: ${e}`);if(c||(d.value.push(e),v&&(g.value=v)),!f.value[C]){const h=await G(e);f.value[C]={pdf:ae(h),highlight:l.matchedPages.includes(e)?H.value:""}}d.value.pop(),d.value.length?j(d.value[0],{forceLoad:!0}):setTimeout(()=>{g.value=0},we)}const xe=z.debounce(e=>{j(e)},100),fe=Qe(),U=w(null);function Ie(e){const v=U.value.querySelectorAll(".reportViewer__page")[e-1];return v==null?void 0:v.offsetTop}function Me(e){e<1||e>l.report.totalPages||Number.isNaN(e)||(ve(e),P("page",e))}async function ve(e){const c=Ie(e),v=j(e,{anchor:c});e>1&&j(e-1),e<l.report.totalPages&&j(e+1),c&&U.value.scrollTo({top:c}),await v,$.value=e}X(()=>l.page,async()=>{await ve(l.page)});function Ce(){var e;i.value.customScale=(((e=n.value)==null?void 0:e.scale)||1)*(1+me),o.value="custom"}function Ve(){var e;i.value.customScale=(((e=n.value)==null?void 0:e.scale)||1)*(1-me),o.value="custom"}function Le(){o.value="fit-width"}function Ee(){o.value="fit-height"}X(n,async(e,c)=>{if(!e||!c||!U.value)return;const v=U.value,C=v.clientHeight/2,h=(v.scrollTop+C)/v.scrollHeight;await ie();const x=v.scrollHeight*h-C;g.value=x,setTimeout(()=>{g.value=0},we)});const Te=z.debounce(e=>{$.value=e,Fe()},oo),Fe=z.debounce(()=>{P("view-page",$.value)},ao);return(e,c)=>{const v=Xe,C=Ze;return p(),y("div",zt,[t("div",Bt,[t("div",Dt,[t("div",Kt,[T(t("input",{class:"reportViewer__pageInput b--moon-gray ba ph1 mr1","onUpdate:modelValue":c[0]||(c[0]=h=>be(r)?r.value=h:null),onKeyup:c[1]||(c[1]=Ge(h=>h.target.blur(),["enter"]))},null,544),[[ue,a(r),void 0,{lazy:!0}]]),V("頁 / 共 "+F(e.report.totalPages)+" 頁",1),t("button",{class:"reportViewer__button ml2 gray",onClick:N},F(a(k)),1)]),t("div",{class:"flex items-center"},[t("button",{class:"reportViewer__button",onClick:Ce},[Gt,V("放大")]),t("button",{class:"reportViewer__button",onClick:Ve},[Wt,V("縮小")]),t("button",{class:"reportViewer__button",onClick:Le},[qt,V("滿頁寬")]),t("button",{class:"reportViewer__button",onClick:Ee},[Jt,V("滿頁高")])])])]),t("div",{class:"reportViewer__scrollContainer relative",ref_key:"scrollerEle",ref:U},[a(E)?(p(),y("div",Yt,[(p(!0),y(O,null,Z(a(f),(h,x)=>(p(),y(O,{key:x},[h?(p(),ce(C,We({key:1,class:"reportViewer__page"},h.pdf,{class:[`thePage--${x+1}`],highlight:h.highlight,"page-anchor":a(g),scale:a(n).scale,onVisible:q=>a(Te)(x+1)}),null,16,["class","highlight","page-anchor","scale","onVisible"])):(p(),ce(v,{key:0,class:re(["reportViewer__page",[`theEmpty--${x+1}`]]),style:ge(a(W)),"page-number":x+1,onVisible:q=>a(xe)(x+1)},null,8,["style","class","page-number","onVisible"])),a(M)?(p(),y("div",{key:2,class:"reportViewer__page reportViewer__page--mask center pointer",style:ge(a(Pe)),onClick:q=>S(x+1)},Zt,12,Qt)):ee("",!0)],64))),128))])):ee("",!0)],512)])}}});const so=te(no,[["__scopeId","data-v-6132997c"]]),lo={key:0,class:"editor"},ro={class:"editor__viewer"},vo=B({__name:"[reportId]",setup(_){const P=qe(),l=b(()=>Number.parseInt(P.params.reportId)),{report:I,reportFieldList:s,isDataReady:L,meta:d}=et(l.value),g=b(()=>Number.parseInt(P.query.fieldId)),m=b(()=>s.value.find(A=>A.id===g.value)||s.value[0]);function f(u){Object.keys(u).forEach(A=>{m.value[A]=u[A]})}const $=b(()=>d(m.value)),r=w({page:1,highlight:""}),M=w([]),N=w(0);function k(u){N.value=u}function S(u){r.value=u}function o(u){M.value=u}const i=Je(),n=b(()=>s.value.findIndex(u=>u.id===g.value));function E(){let u=n.value+1;u===s.value.length&&(u=0),i.push({name:"profession-editor-reportId",params:{reportId:l.value},query:{fieldId:s.value[u].id}})}function R(){let u=n.value-1;u<0&&(u=s.value.length-1),i.push({name:"profession-editor-reportId",params:{reportId:l.value},query:{fieldId:s.value[u].id}})}function H(){window.location.reload()}return(u,A)=>{const G=jt,oe=so;return a(L)?(p(),y("div",lo,[Y(G,{class:"editor__control br b--moon-gray",report:a(I),"report-field":a(m),"field-meta":a($),onPage:S,onMatchedPages:o,onNext:E,onPrev:R,onReportField:f},null,8,["report","report-field","field-meta"]),t("div",ro,[a(r)?(p(),ce(oe,{key:0,year:a(I).year,report:a(I),page:a(r).page,highlight:a(r).highlight,"matched-pages":a(M),onViewPage:k,onReload:H},null,8,["year","report","page","highlight","matched-pages"])):ee("",!0)])])):ee("",!0)}}});export{vo as default};
