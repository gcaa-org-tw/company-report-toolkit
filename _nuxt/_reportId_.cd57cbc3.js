import{_ as De}from"./nuxt-link.9666b35e.js";import{f as ee,r as f,h as m,B as _e,z as X,o as c,c as d,a as t,F as N,y as re,C as le,i as a,t as A,q as Y,v as we,s as be,D as ye,m as Ge,A as ie,_ as te,b as Q,w as Ue,d as M,j,p as Pe,e as ke,L as $e,u as We,E as ae,l as qe,G as Je,H as Qe,I as ce,J as he,K as Xe,g as Ye,M as Ze}from"./entry.0c6ce048.js";import{_ as Z,a as et}from"./lodash.73611309.js";import{a as tt,_ as ot,b as at}from"./SinglePdfPage.3f750321.js";import{t as Se,_ as st,a as nt}from"./AnswerPanel.vue.1b9e0ebf.js";import{u as Ce}from"./useProfessionApi.cd19d6f9.js";import{u as rt}from"./index.c1841803.js";import{u as lt}from"./useReport.8c48b18c.js";const it={class:"searchPanel"},ct={class:"flex mt2"},ut={class:"flex flex-wrap"},dt=["onClick"],pt={class:"f6 dark-gray mv1"},ft=["onClick"],_t={class:"flex-none dark-gray"},ht=["innerHTML"],J=15,gt=ee({__name:"SearchPanel",props:{report:{},fieldMeta:{}},emits:["matched-pages","page"],setup($,{emit:w}){const l=$,x=Ge(),O=tt(x.public.algoliaAppId,x.public.algoliaSearchApiKey).initIndex(x.public.algoliaIndexName),I=f(""),g=f(""),_=f([]),P=f(null),b=m(()=>g.value||I.value||"");_e(()=>{l.fieldMeta.keywords.length&&(I.value=l.fieldMeta.keywords[0])}),X([I,g],([n,h],[s,V])=>{n!==s&&n?g.value="":h!==V&&h&&(I.value="")});function C(n){I.value=n}_e(()=>{b.value&&i()});async function i(){if(!b.value){_.value=[],P.value=null;return}const{hits:n}=await O.search(b.value,{facetFilters:[`company:${l.report.company.id}`,`year:${l.report.year}`],hitsPerPage:100});_.value=n.filter(h=>h.page<=l.report.totalPages),P.value=null}X(_,n=>{const h=n.map(s=>s.page);w("matched-pages",h)});function E(n){n=n.replace(/\n/g,"");const h=`${b.value||""}`,s=n.indexOf(h),V=h.length+J;if(s<0)return n.slice(0,V*2);const H=h.length;let z=n.slice(0,s);const B=`${n.slice(s+H,s+H+J)}...`;if(s>J)z=`...${n.slice(s-J,s)}`;else return n.slice(0,V*2)+"...";return`${Z.escape(z)}<b class="underline">${h}</b>${Z.escape(B)}`}async function T(n){P.value===n?w("page",{highlight:"",page:1}):P.value=n,await ie(),w("page",{highlight:b.value,page:n.page})}function L(n){return Se(n,l.report)}return(n,h)=>(c(),d("div",it,[t("div",ct,[t("div",ut,[(c(!0),d(N,null,re(n.fieldMeta.keywords,s=>(c(),d("button",{class:le(["searchPanel__keyword pointer ba b--moon-gray br1",{"searchPanel__keyword--active":s===a(b)}]),key:s,onClick:V=>C(s)},A(s),11,dt))),128)),Y(t("input",{class:"mt1 f6 w-100 searchPanel__input","onUpdate:modelValue":h[0]||(h[0]=s=>be(g)?g.value=s:null),placeholder:"自訂關鍵字"},null,512),[[we,a(g),void 0,{trim:!0}]])])]),Y(t("div",pt,[(c(!0),d(N,null,re(a(_),s=>(c(),d("div",{class:le(["flex mv2 dim pointer",{b:s===a(P)}]),key:s.page,onClick:V=>T(s)},[t("div",_t,"頁"+A(L(s.page)),1),t("div",{class:"pl2",innerHTML:E(s.content)},null,8,ht)],10,ft))),128))],512),[[ye,a(_).length]])]))}});const vt=te(gt,[["__scopeId","data-v-f86955e2"]]),mt=te(st,[["__scopeId","data-v-0dfc0c60"]]),W=$=>(Pe("data-v-aaa39382"),$=$(),ke(),$),wt={class:"editorControl"},bt={class:"ph3"},yt=W(()=>t("i",{class:"fa-solid fa-arrow-left mr1"},null,-1)),Pt={class:"editorControl__keepTop mt2 pv2 ph3 mb2 bb b--moon-gray"},kt={class:"fw6 f4 mv0 black"},$t={class:"ph3"},St={class:"gray f6 mt0 pb2 mb3 bb b--moon-gray lh-copy"},Ct={class:"editorControl__keywordSection pb2 mb3"},xt=W(()=>t("div",{class:"editorControl__keepMiddle fw5 mb1"},"相關關鍵字",-1)),It=W(()=>t("div",{class:"f6 gray"},"點選以下關鍵字，或是自行輸入，就能搜出相關頁面",-1)),Mt={key:0,class:"editorControl__keepBottom pv2 ph3 bt ba b--moon-gray shadow-1 br2"},Lt={class:"flex justify-end"},Vt=W(()=>t("i",{class:"fa-solid fa-eye ml2 f7"},null,-1)),Et=W(()=>t("i",{class:"fa-solid fa-eye-slash ml2 f7"},null,-1)),Tt={class:"mt2"},Ft=ee({__name:"EditorControl",props:{report:{},reportField:{},fieldMeta:{},focusedPage:{}},emits:["page","matched-pages","next","prev","report-field"],setup($,{emit:w}){const l=$,{isCollaborator:x}=Ce(),S=m(()=>({name:"profession-report-reportId",params:{reportId:l.report.id}}));function O(i){w("matched-pages",i)}function I(i){w("page",i)}const g=f(!1);function _(){g.value=!g.value}function P(i){w("report-field",i),b()}function b(){w("next")}function C(){w("prev")}return(i,E)=>{const T=De,L=vt,n=mt;return c(),d("div",wt,[t("div",bt,[Q(T,{class:"flex f6 gray items-center no-underline dim pt3",to:a(S)},{default:Ue(()=>[yt,M(A(i.report.company.abbreviation)+" "+A(i.report.year)+" 報告書",1)]),_:1},8,["to"])]),t("div",Pt,[t("h1",kt,A(i.fieldMeta.name),1)]),t("div",$t,[t("p",St,A(i.fieldMeta.description),1),t("div",{class:"flex justify-between items-center mb3 mt2 pb3 bb b--moon-gray"},[t("button",{class:"editorControl__nav",onClick:C},"往上個欄位"),t("button",{class:"editorControl__nav",onClick:b},"往下個欄位")]),t("div",Ct,[xt,It,Q(L,{report:i.report,"field-meta":i.fieldMeta,onMatchedPages:O,onPage:I},null,8,["report","field-meta"])])]),a(x)?(c(),d("div",Mt,[t("div",Lt,[t("button",{class:"pv2 ph3 ba bg-dark-gray white br2 pointer f6 flex items-baseline",onClick:_},[a(g)?(c(),d(N,{key:0},[M("展開填答 x 驗證區"),Vt],64)):(c(),d(N,{key:1},[M("收合填答 x 驗證區"),Et],64))])]),Y(t("div",Tt,[Q(n,{report:i.report,"report-field":i.reportField,"field-meta":i.fieldMeta,"focused-page":i.focusedPage,onNext:P},null,8,["report","report-field","field-meta","focused-page"])],512),[[ye,!a(g)]])])):j("",!0)])}}});const Nt=te(Ft,[["__scopeId","data-v-aaa39382"]]),oe=$=>(Pe("data-v-6bc90ced"),$=$(),ke(),$),Ot={class:"reportViewer"},Rt={class:"reportViewer__control pr2"},At={class:"bb b--moon-gray flex items-center justify-between pv2"},Ht={class:"flex items-center pl3"},jt=oe(()=>t("i",{class:"fa-solid fa-plus"},null,-1)),zt=oe(()=>t("i",{class:"fa-solid fa-minus"},null,-1)),Bt=oe(()=>t("i",{class:"fa-solid fa-arrows-left-right"},null,-1)),Kt=oe(()=>t("i",{class:"fa-solid fa-arrows-up-down"},null,-1)),Dt={key:0,class:"reportViewer__content w-100"},Gt={class:"flex flex-column items-center justify-center h-100 f3 fw6 flex-auto"},Ut=["onClick"],Wt={key:0,class:"flex flex-column items-center justify-center h-100 f3 fw6 flex-auto"},qt=["onClick"],se="https://cdn.jsdelivr.net/npm/pdfjs-dist@3.9.179",Jt="https://gcaa-static.s3.ap-northeast-3.amazonaws.com/company-report-toolkit",ne=10,Qt=100,Xt=60,ge=.1,ve=100,Yt=ee({__name:"PdfViewer",props:{page:{default:1},year:{default:2019},report:{},highlight:{default:""},matchedPages:{default(){return[]}}},emits:["view-page","page","reload"],setup($,{emit:w}){const l=$,x=$e(),{feathers:S,isCollaborator:O}=Ce();We({link:[{rel:"stylesheet",href:`${se}/web/pdf_viewer.css`}]});const I=f(!1),g=f(void 0),_=f([]),P=f(0),b=ae({}),C=f([null]),i=f(!1);function E(){i.value=!i.value}const T=f(1),L=f(1),n=m({get(){return Se(L.value,l.report)},set(e){const r=nt(Number.parseInt(e,10),l.report);Oe(r)}}),h=m(()=>{let e=l.report.pageOffset||0,r=l.report.totalPages;return l.report.is2Pages&&(r=r*2-1),e&&(r+=e,e=Math.abs(e)),`${r} + ${Math.abs(e)}`}),s=f(!1);function V(){l.report.hasSetPageOffset||!O.value?s.value=!1:(s.value=!0,x.add({type:"warning",text:"歡迎光臨，我們先校正報告書的第一頁吧 🍥",duration:5e3}))}const H=()=>{s.value=!s.value},z=m(()=>s.value?"取消設定報告第一頁":"頁次對不上？點此調整");async function B(e,r){i.value&&e>1&&(e=(e-1)*2+(r?0:1));const u=1-e;try{await S.app.service("report").patch(l.report.id,{pageOffset:u,is2Pages:i.value}),w("reload"),s.value=!1}catch(v){throw v.message&&x.add({type:"error",text:v.message}),v}}const R=f("fit-width"),o=f({pdfSize:{width:0,height:0},widthScale:0,heightScale:0,customScale:0}),y=m(()=>{if(!o.value.widthScale||!pe.value)return null;let e=1;switch(R.value){case"custom":e=o.value.customScale;break;case"fit-height":e=o.value.heightScale;break;case"fit-width":default:e=o.value.widthScale}return e=e||1,{scale:e,width:o.value.pdfSize.width*e,height:o.value.pdfSize.height*e}});qe(()=>{ue()}),Je(()=>{clearTimeout(g.value)});const F=m(()=>C.value[0]&&y.value),K=m(()=>`${Jt}/${l.year}/${l.report.company.id}`),xe=m(()=>l.highlight+"");function Ie(){return!!window&&!!window.pdfjsLib&&!!window.pdfjsViewer}function ue(){g.value=setTimeout(async()=>{const e=Ie();e?(window.pdfjsLib.GlobalWorkerOptions.workerSrc=`${se}/build/pdf.worker.js`,await ie()):ue(),I.value=e},Qt)}async function de(e){const r=window.pdfjsLib,u=`${se}/cmaps/`,v=e%ne||ne,p=Te(e);b.value[p]||(b.value[p]=r.getDocument({url:`${K.value}/${p}.pdf`,cMapUrl:u,cMapPacked:!0,enableXfa:!0}));const k=await b.value[p].promise;return Me(k),{document:k,page:v}}async function Me(e){if(o.value.widthScale)return;const r=await e.getPage(1),{width:u,height:v}=r.getViewport({scale:1});o.value.pdfSize={width:u,height:v};const p=D.value,k=p.clientWidth,U=p.clientHeight,Be=Number.parseInt(getComputedStyle(p).paddingLeft),Ke=k-Be*2;o.value.widthScale=Ke/u,o.value.heightScale=U/v}const q=m(()=>{var e,r;return y.value?{width:`${(e=y.value)==null?void 0:e.width}px`,height:`${(r=y.value)==null?void 0:r.height}px`}:{}}),Le=m(()=>q.value.height?{...q.value,marginTop:`-${q.value.height}`}:{});async function Ve(){const e=await de(1);C.value[0]={pdf:ae(e)}}function Ee(){b.value={},C.value=Array(l.report.totalPages).fill(null),R.value="fit-width",o.value.widthScale=0}function Te(e){return`${Math.ceil(e/ne)}`.padStart(3,"0")}async function G(e,{forceLoad:r=!1,anchor:u=0}={}){if(!r&&_.value.length){_.value.includes(e)||_.value.unshift(e);return}const v=e-1;if(v>=C.value.length)throw new Error(`Invalid page number: ${e}`);if(r||(_.value.push(e),u&&(P.value=u)),!C.value[v]){const p=await de(e);C.value[v]={pdf:ae(p),highlight:l.matchedPages.includes(e)?xe.value:""}}_.value.pop(),_.value.length?G(_.value[0],{forceLoad:!0}):setTimeout(()=>{P.value=0},ve)}const Fe=Z.debounce(e=>{G(e)},100),pe=rt(),D=f(null);et(()=>K.value&&!I.value&&!pe.value,()=>{Ee(),Ve(),V()});function Ne(e){const u=D.value.querySelectorAll(".reportViewer__page")[e-1];return u==null?void 0:u.offsetTop}function Oe(e){e<1||e>l.report.totalPages||Number.isNaN(e)||(fe(e),w("page",e))}async function fe(e){e=Math.floor(e);const r=Ne(e),u=G(e,{anchor:r});e>1&&G(e-1),e<l.report.totalPages&&G(e+1),r&&D.value.scrollTo({top:r}),await u,L.value=e}X(()=>l.page,async()=>{await fe(l.page)});function Re(){var e;o.value.customScale=(((e=y.value)==null?void 0:e.scale)||1)*(1+ge),R.value="custom"}function Ae(){var e;o.value.customScale=(((e=y.value)==null?void 0:e.scale)||1)*(1-ge),R.value="custom"}function He(){R.value="fit-width"}function je(){R.value="fit-height"}X(y,async(e,r)=>{if(!e||!r||!D.value)return;const u=D.value,v=u.clientHeight/2,p=(u.scrollTop+v)/u.scrollHeight;await ie();const k=u.scrollHeight*p-v;P.value=k,setTimeout(()=>{P.value=0},ve)});const ze=Z.debounce(e=>{e!==T.value&&(L.value=T.value,T.value=e,w("view-page",L.value))},Xt);return(e,r)=>{const u=ot,v=at;return c(),d("div",Ot,[t("div",Rt,[t("div",At,[t("div",Ht,[Y(t("input",{class:"reportViewer__pageInput b--moon-gray ba ph1 mr1","onUpdate:modelValue":r[0]||(r[0]=p=>be(n)?n.value=p:null),onKeyup:r[1]||(r[1]=Qe(p=>p.target.blur(),["enter"]))},null,544),[[we,a(n),void 0,{lazy:!0}]]),M("頁 / 共 "+A(a(h))+" 頁",1),a(O)?(c(),d("button",{key:0,class:"reportViewer__button ml2 gray",onClick:H},A(a(z)),1)):j("",!0)]),t("div",{class:"flex items-center"},[t("button",{class:"reportViewer__button",onClick:Re},[jt,M("放大")]),t("button",{class:"reportViewer__button",onClick:Ae},[zt,M("縮小")]),t("button",{class:"reportViewer__button",onClick:He},[Bt,M("滿頁寬")]),t("button",{class:"reportViewer__button",onClick:je},[Kt,M("滿頁高")])])])]),t("div",{class:"reportViewer__scrollContainer relative",ref_key:"scrollerEle",ref:D},[a(F)?(c(),d("div",Dt,[(c(!0),d(N,null,re(a(C),(p,k)=>(c(),d(N,{key:k},[p?(c(),ce(v,Xe({key:1,class:"reportViewer__page"},p.pdf,{class:[`thePage--${k+1}`],highlight:p.highlight,"page-anchor":a(P),scale:a(y).scale,onVisible:U=>a(ze)(k+1)}),null,16,["class","highlight","page-anchor","scale","onVisible"])):(c(),ce(u,{key:0,class:le(["reportViewer__page",[`theEmpty--${k+1}`]]),style:he(a(q)),"page-number":k+1,onVisible:U=>a(Fe)(k+1)},null,8,["style","class","page-number","onVisible"])),a(s)?(c(),d("div",{key:2,class:"reportViewer__page reportViewer__page--mask center pointer flex",style:he(a(Le))},[t("div",Gt,[t("div",{class:"reportViewer__maskLabel pv3 ph4 br2 mb3",onClick:E},[a(i)?(c(),d(N,{key:0},[M("切換為單頁模式")],64)):(c(),d(N,{key:1},[M("切換為雙頁模式")],64))]),t("div",{class:"reportViewer__maskLabel pv3 ph4 br2",onClick:U=>B(k+1,!0)},"設定為第一頁",8,Ut)]),a(i)?(c(),d("div",Wt,[t("div",{class:"reportViewer__maskLabel pv3 ph4 br2 mb3",onClick:E},[a(i)?(c(),d(N,{key:0},[M("切換為單頁模式")],64)):(c(),d(N,{key:1},[M("切換為雙頁模式")],64))]),t("div",{class:"reportViewer__maskLabel pv3 ph4 br2",onClick:U=>B(k+1,!1)},"設定為第一頁",8,qt)])):j("",!0)],4)):j("",!0)],64))),128))])):j("",!0)],512)])}}});const Zt=te(Yt,[["__scopeId","data-v-6bc90ced"]]),eo={key:0,class:"editor"},to={class:"editor__viewer"},me="看完收工！ 🎉 找找頁面左上角，就能回上一層",oo=5,po=ee({__name:"[reportId]",setup($){const w=Ye(),l=m(()=>Number.parseInt(w.params.reportId)),{report:x,reportFieldList:S,isDataReady:O,meta:I}=lt(l.value),g=m(()=>Number.parseInt(w.query.fieldId)),_=m(()=>S.value.find(y=>y.id===g.value)||S.value[0]),P=$e();function b(o){Object.keys(o).forEach(F=>{_.value[F]=o[F]});const y=i.value===me?8e3:4e3;P.add({type:"success",duration:y,text:i.value})}const C=m(()=>I(_.value)),i=m(()=>{const o=S.value.filter(K=>!!K.value).length,y=S.value.length,F=y-o;return F?F<=oo?`最後 ${F} 個欄位！ 🧙`:`已完成 ${o} / ${y} 個欄位 🤖`:me}),E=f({page:1,highlight:""}),T=f([]),L=f(0);function n(o){L.value=o}function h(o){E.value=o}function s(o){T.value=o}const V=Ze(),H=m(()=>S.value.findIndex(o=>o.id===g.value));function z(){let o=H.value+1;o===S.value.length&&(o=0),V.push({name:"profession-editor-reportId",params:{reportId:l.value},query:{fieldId:S.value[o].id}})}function B(){let o=H.value-1;o<0&&(o=S.value.length-1),V.push({name:"profession-editor-reportId",params:{reportId:l.value},query:{fieldId:S.value[o].id}})}function R(){window.location.reload()}return(o,y)=>{const F=Nt,K=Zt;return a(O)?(c(),d("div",eo,[Q(F,{class:"editor__control br b--moon-gray",report:a(x),"report-field":a(_),"field-meta":a(C),"focused-page":a(L),onPage:h,onMatchedPages:s,onNext:z,onPrev:B,onReportField:b},null,8,["report","report-field","field-meta","focused-page"]),t("div",to,[a(E)?(c(),ce(K,{key:0,year:a(x).year,report:a(x),page:a(E).page,highlight:a(E).highlight,"matched-pages":a(T),onViewPage:n,onReload:R},null,8,["year","report","page","highlight","matched-pages"])):j("",!0)])])):j("",!0)}}});export{po as default};
