import{u as x}from"./useProfessionApi.e687d293.js";import{u as U}from"./useFieldMeta.ab8eef88.js";import{N as W}from"./AnswerPanel.vue.96ff0400.js";import{f as C,r as S,h as w,o as f,c as _,i as u,d as z,a as e,t as d,F as M,y as N,j as G,q as H,N as J,s as K,b as Q}from"./entry.0f2fa65d.js";import{w as D}from"./lodash.512a68f9.js";import"./index.8089a7a1.js";var h={},X=Y;function Y(t){return!isNaN(parseFloat(t))&&isFinite(t)}h.numbers=v;h.sum=$;h.mean=L;h.median=tt;h.mode=et;h.variance=E;h.sampleVariance=P;h.populationVariance=E;h.stdev=B;h.sampleStdev=nt;h.populationStdev=B;h.percentile=rt;h.histogram=at;var Z=X;function v(t){var n=[];if(t==null)return n;for(var r=0;r<t.length;r++)Z(t[r])&&n.push(+t[r]);return n}function F(t){return t.sort(function(r,a){return r-a})}function $(t){t=v(t);for(var n=0,r=0;r<t.length;r++)n+=t[r];return n}function L(t){return t=v(t),t.length===0?NaN:$(t)/t.length}function tt(t){if(t=v(t),t.length===0)return NaN;var n=t.length/2|0;return t=F(t),t.length%2?t[n]:(t[n-1]+t[n])/2}function et(t){if(t=v(t),t.length===0)return NaN;for(var n=NaN,r={},a=0;a<t.length;a++){var g=t[a],m=r[g]||0;m++,r[g]=m}var p=v(Object.keys(r).sort(function(s,k){return r[k]-r[s]}));if(n=p[0],r[p[1]]==r[n]){if(p.length==t.length)return t;for(var c=new Set([n]),y=r[n],a=1;a<p.length&&r[p[a]]==y;a++)c.add(p[a]);return c}return n}function j(t){t=v(t);for(var n=L(t),r=[],a=0;a<t.length;a++)r.push(Math.pow(t[a]-n,2));return r}function E(t){return L(j(t))}function P(t){var n=j(t);return n.length<=1?NaN:$(n)/(n.length-1)}function B(t){return Math.sqrt(E(t))}function nt(t){return Math.sqrt(P(t))}function rt(t,n){if(t=v(t),t.length===0||n==null||n<0)return NaN;n>1&&(n=1),t=F(t);var r=t.length*n-.5;if((r|0)===r)return t[r];var a=r|0,g=r-a;return(1-g)*t[a]+g*t[Math.min(a+1,t.length-1)]}function at(t,n){if(t==null||(t=F(v(t)),t.length===0))return null;n==null&&(n=Math.sqrt(t.length)),n=Math.round(n),n<1&&(n=1);var r=t[0],a=t[t.length-1];r===a&&(r=r-.5,a=a+.5);var g=a-r,m=(g+g*.05)/n,p=(r+a)/2,c=p-m*Math.floor(n/2);if(n%2!==0)var c=p-m/2-m*Math.floor(n/2);for(var y={values:Array(n).fill(0),bins:n,binWidth:m,binLimits:[c,c+m*n]},b=0,s=0;s<t.length;s++){for(;t[s]>(b+1)*m+c;)b++;y.values[b]++}return y}const st={class:"detailStats"},ot={key:0,class:"mv5 tc f2"},it={class:"fw7"},lt={key:1,class:"w-100 ba b--moon-gray",cellspacing:"0"},dt=e("thead",null,[e("tr",{class:"bg-light-gray tl"},[e("th",null,"公司名稱"),e("th",null,"年度"),e("th",null,"欄位名稱"),e("th",null,"填答時間（分）"),e("th",null,"管理員改過"),e("th",null,"無法填答")])],-1),ut={key:2,class:"w-100 ba b--moon-gray",cellspacing:"0"},ct=e("thead",null,[e("tr",{class:"bg-light-gray tl"},[e("th",null,"欄位名稱"),e("th",null,"平均填答時間（分）"),e("th",null,"中位數填答時間（分）"),e("th",null,"標準差填答時間（分）"),e("th",null,"管理員改過比例"),e("th",null,"填答次數")])],-1),pt=C({__name:"DetailStats",props:{reportList:{},statsType:{}},setup(t){const n=t,{feathers:r}=x(),{fieldMetaList:a,fieldMetaMap:g}=U(),m=S([]),p=S(0),c=w(()=>{const i=new Map;for(const l of n.reportList)i.set(l.id,l);return i}),y=w(()=>{const i=new Map;m.value.forEach(l=>{i.has(l.fieldId)||i.set(l.fieldId,{timeSpentList:[],meanTimeSpent:0,medianTimeSpent:0,stdTimeSpend:0,adminEditCount:0,adminEditRatio:0,count:0});const o=i.get(l.fieldId);o.timeSpentList.push(l.timeSpentInSeconds),o.adminEditCount+=l.hasAdminEdited?1:0,o.count+=1});for(const[,l]of i)l.meanTimeSpent=h.mean(l.timeSpentList),l.medianTimeSpent=h.median(l.timeSpentList),l.stdTimeSpend=h.stdev(l.timeSpentList),l.adminEditRatio=Math.round(l.adminEditCount*100/l.count);return i}),b=w(()=>a.value.filter(i=>y.value.has(i.id)));function s(i){return Math.round(i*10/60)/10}function k(i=0){return r.app.service("report-field").find({query:{timeSpentInSeconds:{$gt:0},$select:["fieldId","reportId","timeSpentInSeconds","hasAdminEdited","value"],$limit:500,$sort:{reportId:1,fieldId:1},$skip:i}})}async function O(){let i=0;const l=[];for(;;){const o=await k(i);if(l.push(...o.data),!o.data.length){p.value=100;break}i=o.skip+o.data.length,p.value=Math.floor(i*100/o.total)}m.value=l}return D(r.isReady,i=>{i&&O()}),(i,l)=>(f(),_("div",st,[u(p)<100?(f(),_("h1",ot,[z(" 資料載入中... "),e("span",it,d(u(p))+"%",1)])):i.statsType===u(I).reportField?(f(),_("table",lt,[dt,e("tbody",null,[(f(!0),_(M,null,N(u(m),o=>(f(),_("tr",{key:o.id},[e("td",null,d(u(c).get(o.reportId).company.name),1),e("td",null,d(u(c).get(o.reportId).year),1),e("td",null,d(u(g).get(o.fieldId).name),1),e("td",null,d(s(o.timeSpentInSeconds)),1),e("td",null,d(o.hasAdminEdited?"✅":"-"),1),e("td",null,d(o.value===u(W)?"✅":"-"),1)]))),128))])])):i.statsType===u(I).fieldMeta?(f(),_("table",ut,[ct,e("tbody",null,[(f(!0),_(M,null,N(u(b),o=>{var T,V,R,A,q;return f(),_("tr",{key:o.id},[e("td",null,d(o.name),1),e("td",null,d(s(((T=u(y).get(o.id))==null?void 0:T.meanTimeSpent)||0)),1),e("td",null,d(s(((V=u(y).get(o.id))==null?void 0:V.medianTimeSpent)||0)),1),e("td",null,d(s(((R=u(y).get(o.id))==null?void 0:R.stdTimeSpend)||0)),1),e("td",null,d(((A=u(y).get(o.id))==null?void 0:A.adminEditRatio)||0)+"%",1),e("td",null,d(((q=u(y).get(o.id))==null?void 0:q.count)||0),1)])}),128))])])):G("",!0)]))}});const ht={class:"stats pa4 lh-copy"},mt=e("div",{class:"pb3"},[e("h1",{class:"f2 fw6"},"使用狀況統計"),e("p",{class:"f4 mb4"}," 這裡只會顯示有判讀過的報告書，若要下載原始資料，請在下拉選單選取「原始資料」。 ")],-1),ft={class:"pv3 flex items-center justify-end mb4 bt bb b--moon-gray"},_t=["value"],gt={key:0,class:"f6"},yt={class:"w-100 ba b--moon-gray",cellspacing:"0"},vt=e("thead",null,[e("tr",{class:"bg-light-gray tl"},[e("th",{class:"pv2 ph3"},"公司名稱"),e("th",{class:"pv2 ph3"},"統編"),e("th",{class:"pv2 ph3"},"股票代碼"),e("th",{class:"pv2 ph3"},"報告書年度"),e("th",{class:"pv2 ph3"},"填答完成度"),e("th",{class:"pv2 ph3"},"是否驗證完畢"),e("th",{class:"pv2 ph3"},"目前累計時間（分）")])],-1),bt={class:"pv2 ph3 bt b--moon-gray"},St={class:"pv2 ph3 bt b--moon-gray"},Mt={class:"pv2 ph3 bt b--moon-gray"},Nt={class:"pv2 ph3 bt b--moon-gray"},It={class:"pv2 ph3 bt b--moon-gray"},kt={class:"pv2 ph3 bt b--moon-gray"},wt={class:"pv2 ph3 bt b--moon-gray"},Ft={key:1,class:"f6"};var I=(t=>(t.report="各報告書",t.fieldMeta="各欄位",t.reportField="原始資料",t))(I||{});const At=C({__name:"stats",setup(t){const{feathers:n}=x(),r=Object.values(I),a=S("各報告書"),g=S([]);function m(c){return Math.round(c.timeSpentInSeconds*10/60)/10}function p(){n.app.service("report").find({query:{timeSpentInSeconds:{$gt:0},$limit:500,$sort:{answeredFields:-1}}}).then(c=>{g.value=c.data})}return D(n.isReady,c=>{c&&p()}),(c,y)=>{const b=pt;return f(),_("div",ht,[mt,e("div",ft,[H(e("select",{"onUpdate:modelValue":y[0]||(y[0]=s=>K(a)?a.value=s:null),class:"stats__control"},[(f(!0),_(M,null,N(u(r),s=>(f(),_("option",{key:s,value:s},d(s),9,_t))),128))],512),[[J,u(a)]])]),u(a)==="各報告書"?(f(),_("div",gt,[e("table",yt,[vt,e("tbody",null,[(f(!0),_(M,null,N(u(g),s=>(f(),_("tr",{key:s.id},[e("td",bt,d(s.company.name),1),e("td",St,d(s.company.id),1),e("td",Mt,d(s.company.stockCode),1),e("td",Nt,d(s.year),1),e("td",It,d(s.answeredFields)+"/"+d(s.totalFields),1),e("td",kt,d(s.isVerified?"✅":"-"),1),e("td",wt,d(m(s)),1)]))),128))])])])):(f(),_("div",Ft,[Q(b,{"report-list":u(g),"stats-type":u(a)},null,8,["report-list","stats-type"])]))])}}});export{I as StatsType,At as default};
