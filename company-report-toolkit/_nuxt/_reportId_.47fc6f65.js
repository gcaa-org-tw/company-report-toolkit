import{_ as Ne}from"./nuxt-link.f4044d9c.js";import{g as Y,r as _,i as w,z as H,o as g,c as S,a as t,F as z,y as oe,C as ae,j as n,t as F,q as R,v as Q,s as _e,D as fe,n as Ae,A as ne,_ as ie,B as he,b as se,w as Oe,d as L,x as He,p as ve,e as ge,u as Re,E as Z,m as ze,G as je,H as Be,I as le,J as ue,K as De,k as X,h as Ke,L as Ue}from"./entry.e24198ec.js";import{a as Ge,_ as D,u as We,b as qe,c as Je}from"./SinglePdfPage.031a82f3.js";import{u as me}from"./useProfessionApi.64e827a8.js";import{u as Qe}from"./useReport.067ddb80.js";import"./_commonjsHelpers.5a7388aa.js";const Xe={class:"searchPanel"},Ye={class:"flex mt2"},Ze={class:"flex flex-wrap"},et=["onClick"],tt={class:"f6 dark-gray mv1"},ot=["onClick"],at={class:"flex-none dark-gray"},nt=["innerHTML"],J=15,st=Y({__name:"SearchPanel",props:{report:{},fieldMeta:{}},emits:["matched-pages","page"],setup(y,{emit:m}){const l=y,x=Ae(),E=Ge(x.public.algoliaAppId,x.public.algoliaSearchApiKey).initIndex(x.public.algoliaIndexName),h=_(""),u=_(""),r=_([]),v=_(null),f=w(()=>u.value||h.value||"");H(()=>l.fieldMeta,o=>{o.keywords.length&&(h.value=o.keywords[0])}),H([h,u],([o,s],[a,M])=>{o!==a&&o?u.value="":s!==M&&s&&(h.value="")});function C(o){h.value=o}H(f,()=>{I()});async function I(){if(!f.value){r.value=[],v.value=null;return}const{hits:o}=await E.search(f.value,{facetFilters:[`company:${l.report.company.id}`,`year:${l.report.year}`],hitsPerPage:100});r.value=o,v.value=null}H(r,o=>{const s=o.map(a=>a.page);m("matched-pages",s)});function T(o){o=o.replace(/\n/g,"");const s=`${f.value||""}`,a=o.indexOf(s),M=s.length+J;if(a<0)return o.slice(0,M*2);const N=s.length;let c=o.slice(0,a);const A=`${o.slice(a+N,a+N+J)}...`;if(a>J)c=`...${o.slice(a-J,a)}`;else return o.slice(0,M*2)+"...";return`${D.escape(c)}<b class="underline">${s}</b>${D.escape(A)}`}async function b(o){v.value===o?m("page",{highlight:"",page:1}):v.value=o,await ne(),m("page",{highlight:f.value,page:o.page})}function V(o){return o+(l.report.company.pageOffset||0)}return(o,s)=>(g(),S("div",Xe,[t("div",Ye,[t("div",Ze,[(g(!0),S(z,null,oe(o.fieldMeta.keywords,a=>(g(),S("button",{class:ae(["searchPanel__keyword pointer ba b--moon-gray br1",{"searchPanel__keyword--active":a===n(f)}]),key:a,onClick:M=>C(a)},F(a),11,et))),128)),R(t("input",{class:"mt1 f6 w-100 searchPanel__input","onUpdate:modelValue":s[0]||(s[0]=a=>_e(u)?u.value=a:null),placeholder:"自訂關鍵字"},null,512),[[Q,n(u),void 0,{trim:!0}]])])]),R(t("div",tt,[(g(!0),S(z,null,oe(n(r),a=>(g(),S("div",{class:ae(["flex mv2 dim pointer",{b:a===n(v)}]),key:a.page,onClick:M=>b(a)},[t("div",at,"頁"+F(V(a.page)),1),t("div",{class:"pl2",innerHTML:T(a.content)},null,8,nt)],10,ot))),128))],512),[[fe,n(r).length]])]))}});const lt=ie(st,[["__scopeId","data-v-c4e743c3"]]),j=y=>(ve("data-v-59c5dfee"),y=y(),ge(),y),it={class:"editorControl ph3"},rt=j(()=>t("i",{class:"fa-solid fa-arrow-left mr1"},null,-1)),ct={class:"editorControl__keepTop mt2 pv2 mb3 bb b--moon-gray"},ut={class:"fw6 f4 mt0 mb2 black"},dt={class:"gray f6 mv0 lh-copy"},pt={class:"editorControl__keywordSection pb2 mb3"},_t=j(()=>t("div",{class:"editorControl__keepMiddle fw5 mb1"},"相關關鍵字",-1)),ft=j(()=>t("div",{class:"f6 gray"},"點選以下關鍵字，或是自行輸入，就能搜出相關頁面",-1)),ht={class:"editorControl__keepBottom pb3 pt2 bt b--moon-gray"},vt={class:"flex justify-end"},gt=j(()=>t("i",{class:"fa-solid fa-eye ml2 f7"},null,-1)),mt=j(()=>t("i",{class:"fa-solid fa-eye-slash ml2 f7"},null,-1)),bt=["onSubmit"],wt=j(()=>t("div",{class:"fw5 mb2"},"填寫判讀結果",-1)),yt={class:"flex items-center mb2"},Pt={class:"fieldForm__value flex-auto mr3"},St={class:"fieldForm__unit flex-none"},kt={class:"tr"},$t=["disabled"],xt=Y({__name:"EditorControl",props:{report:{},reportField:{},fieldMeta:{}},emits:["page","matched-pages","next","prev"],setup(y,{emit:m}){const l=y,{feathers:x}=me(),k=w(()=>({name:"profession-report-reportId",params:{reportId:l.report.id}}));function E(b){m("matched-pages",b)}function h(b){m("page",b)}const u=_(!1),r=_({value:"",unit:""}),v=w(()=>r.value.value&&r.value.unit);function f(){u.value=!u.value}he(()=>{l.reportField&&(r.value.value=l.reportField.value||"",r.value.unit=l.reportField.unit||"")});async function C(){await x.app.service("report-field").patch(l.reportField.id,{value:r.value.value,unit:r.value.unit}),m("next")}function I(){m("next")}function T(){m("prev")}return(b,V)=>{const o=Ne,s=lt;return g(),S("div",it,[se(o,{class:"flex f6 gray items-center no-underline dim pt3",to:n(k)},{default:Oe(()=>[rt,L(F(b.report.company.abbreviation)+" "+F(b.report.year)+" 報告書",1)]),_:1},8,["to"]),t("div",ct,[t("h1",ut,F(b.fieldMeta.name),1),t("p",dt,F(b.fieldMeta.description),1)]),t("div",{class:"flex justify-between items-center mb3 mt2 pb3 bb b--moon-gray"},[t("button",{class:"editorControl__nav",onClick:T},"往上個欄位"),t("button",{class:"editorControl__nav",onClick:I},"往下個欄位")]),t("div",pt,[_t,ft,se(s,{report:b.report,"field-meta":b.fieldMeta,onMatchedPages:E,onPage:h},null,8,["report","field-meta"])]),t("div",ht,[t("div",vt,[t("button",{class:"pv1 ph3 ba bg-white pointer f6 gray mb2 flex items-baseline",onClick:f},[n(u)?(g(),S(z,{key:0},[L("展開填答 x 驗證區"),gt],64)):(g(),S(z,{key:1},[L("收合填答 x 驗證區"),mt],64))])]),R(t("form",{class:"fieldForm pb2 bb b--moon-gray",onSubmit:He(C,["prevent"])},[wt,t("div",yt,[t("label",Pt,[L("數值"),R(t("input",{class:"fieldForm__input","onUpdate:modelValue":V[0]||(V[0]=a=>n(r).value=a),type:"text",placeholder:"數值"},null,512),[[Q,n(r).value,void 0,{trim:!0}]])]),t("label",St,[L("單位"),R(t("input",{class:"fieldForm__input","onUpdate:modelValue":V[1]||(V[1]=a=>n(r).unit=a),type:"text",placeholder:"單位"},null,512),[[Q,n(r).unit,void 0,{trim:!0}]])])]),t("div",kt,[t("button",{class:"fieldForm__submit pv2 ph3 bw0 bg--green tc w4 pointer",disabled:!n(v)},"儲存",8,$t)])],40,bt),[[fe,!n(u)]])])])}}});const It=ie(xt,[["__scopeId","data-v-59c5dfee"]]),K=y=>(ve("data-v-6132997c"),y=y(),ge(),y),Ct={class:"reportViewer"},Vt={class:"reportViewer__control pr2"},Mt={class:"bb b--moon-gray flex items-center justify-between pv2"},Lt={class:"flex items-center pl3"},Et=K(()=>t("i",{class:"fa-solid fa-plus"},null,-1)),Ft=K(()=>t("i",{class:"fa-solid fa-minus"},null,-1)),Tt=K(()=>t("i",{class:"fa-solid fa-arrows-left-right"},null,-1)),Nt=K(()=>t("i",{class:"fa-solid fa-arrows-up-down"},null,-1)),At={key:0,class:"reportViewer__content w-100"},Ot=["onClick"],Ht=K(()=>t("div",{class:"flex items-center justify-center h-100 f3 fw6"},[t("div",{class:"reportViewer__maskLabel pv3 ph4 br2"},"設定為第一頁")],-1)),Rt=[Ht],ee="https://cdn.jsdelivr.net/npm/pdfjs-dist@3.9.179",zt="https://gcaa-static.s3.ap-northeast-3.amazonaws.com/company-report-toolkit",te=10,jt=100,Bt=100,Dt=2e3,de=.1,pe=100,Kt=Y({__name:"PdfViewer",props:{page:{default:1},year:{default:2019},report:{},highlight:{default:""},matchedPages:{default(){return[]}}},emits:["view-page","page","reload"],setup(y,{emit:m}){const l=y,{feathers:x}=me();Re({link:[{rel:"stylesheet",href:`${ee}/web/pdf_viewer.css`}]});const k=_(!1),E=_(void 0),h=_([]),u=_(0),r=Z({}),v=_([null]),f=_(1),C=w({get(){const e=f.value+(l.report.pageOffset||0);return e<1?"-":e},set(e){const i=Number.parseInt(e,10)-(l.report.pageOffset||0);xe(i)}}),I=_(!1),T=()=>{I.value=!I.value},b=w(()=>I.value?"取消設定報告第一頁":"頁次對不上？點此調整");async function V(e){const i=1-e;await x.app.service("report").patch(l.report.id,{pageOffset:i}),m("reload"),I.value=!1}const o=_("fit-width"),s=_({pdfSize:{width:0,height:0},widthScale:0,heightScale:0,customScale:0}),a=w(()=>{if(!s.value.widthScale||!re.value)return null;let e=1;switch(o.value){case"custom":e=s.value.customScale;break;case"fit-height":e=s.value.heightScale;break;case"fit-width":default:e=s.value.widthScale}return e=e||1,{scale:e,width:s.value.pdfSize.width*e,height:s.value.pdfSize.height*e}});ze(()=>{U()}),je(()=>{clearTimeout(E.value)});const M=w(()=>v.value[0]&&a.value),N=w(()=>`${zt}/${l.year}/${l.report.company.id}`),c=w(()=>l.highlight+"");function A(){return!!window&&!!window.pdfjsLib&&!!window.pdfjsViewer}function U(){E.value=setTimeout(async()=>{const e=A();e?(window.pdfjsLib.GlobalWorkerOptions.workerSrc=`${ee}/build/pdf.worker.js`,await ne()):U(),k.value=e},jt)}async function G(e){const i=window.pdfjsLib,d=`${ee}/cmaps/`,$=e%te||te,p=Se(e);r.value[p]||(r.value[p]=i.getDocument({url:`${N.value}/${p}.pdf`,cMapUrl:d,cMapPacked:!0,enableXfa:!0}));const P=await r.value[p].promise;return be(P),{document:P,page:$}}async function be(e){if(s.value.widthScale)return;const i=await e.getPage(1),{width:d,height:$}=i.getViewport({scale:1});s.value.pdfSize={width:d,height:$};const p=O.value,P=p.clientWidth,q=p.clientHeight,Fe=Number.parseInt(getComputedStyle(p).paddingLeft),Te=P-Fe*2;s.value.widthScale=Te/d,s.value.heightScale=q/$}const W=w(()=>{var e,i;return a.value?{width:`${(e=a.value)==null?void 0:e.width}px`,height:`${(i=a.value)==null?void 0:i.height}px`}:{}}),we=w(()=>W.value.height?{...W.value,marginTop:`-${W.value.height}`}:{});async function ye(){const e=await G(1);v.value[0]={pdf:Z(e)}}function Pe(){r.value={},v.value=Array(l.report.totalPages).fill(null),o.value="fit-width",s.value.widthScale=0}he(()=>{!N.value||!k.value||!re.value||(Pe(),ye())});function Se(e){return`${Math.ceil(e/te)}`.padStart(3,"0")}async function B(e,{forceLoad:i=!1,anchor:d=0}={}){if(!i&&h.value.length){h.value.includes(e)||h.value.unshift(e);return}const $=e-1;if($>=v.value.length)throw new Error(`Invalid page number: ${e}`);if(i||(h.value.push(e),d&&(u.value=d)),!v.value[$]){const p=await G(e);v.value[$]={pdf:Z(p),highlight:l.matchedPages.includes(e)?c.value:""}}h.value.pop(),h.value.length?B(h.value[0],{forceLoad:!0}):setTimeout(()=>{u.value=0},pe)}const ke=D.debounce(e=>{B(e)},100),re=We(),O=_(null);function $e(e){const d=O.value.querySelectorAll(".reportViewer__page")[e-1];return d==null?void 0:d.offsetTop}function xe(e){e<1||e>l.report.totalPages||Number.isNaN(e)||(ce(e),m("page",e))}async function ce(e){const i=$e(e),d=B(e,{anchor:i});e>1&&B(e-1),e<l.report.totalPages&&B(e+1),i&&O.value.scrollTo({top:i}),await d,f.value=e}H(()=>l.page,async()=>{await ce(l.page)});function Ie(){var e;s.value.customScale=(((e=a.value)==null?void 0:e.scale)||1)*(1+de),o.value="custom"}function Ce(){var e;s.value.customScale=(((e=a.value)==null?void 0:e.scale)||1)*(1-de),o.value="custom"}function Ve(){o.value="fit-width"}function Me(){o.value="fit-height"}H(a,async(e,i)=>{if(!e||!i||!O.value)return;const d=O.value,$=d.clientHeight/2,p=(d.scrollTop+$)/d.scrollHeight;await ne();const P=d.scrollHeight*p-$;u.value=P,setTimeout(()=>{u.value=0},pe)});const Le=D.debounce(e=>{f.value=e,Ee()},Bt),Ee=D.debounce(()=>{m("view-page",f.value)},Dt);return(e,i)=>{const d=qe,$=Je;return g(),S("div",Ct,[t("div",Vt,[t("div",Mt,[t("div",Lt,[R(t("input",{class:"reportViewer__pageInput b--moon-gray ba ph1 mr1","onUpdate:modelValue":i[0]||(i[0]=p=>_e(C)?C.value=p:null),onKeyup:i[1]||(i[1]=Be(p=>p.target.blur(),["enter"]))},null,544),[[Q,n(C),void 0,{lazy:!0}]]),L("頁 / 共 "+F(e.report.totalPages)+" 頁",1),t("button",{class:"reportViewer__button ml2 gray",onClick:T},F(n(b)),1)]),t("div",{class:"flex items-center"},[t("button",{class:"reportViewer__button",onClick:Ie},[Et,L("放大")]),t("button",{class:"reportViewer__button",onClick:Ce},[Ft,L("縮小")]),t("button",{class:"reportViewer__button",onClick:Ve},[Tt,L("滿頁寬")]),t("button",{class:"reportViewer__button",onClick:Me},[Nt,L("滿頁高")])])])]),t("div",{class:"reportViewer__scrollContainer relative",ref_key:"scrollerEle",ref:O},[n(M)?(g(),S("div",At,[(g(!0),S(z,null,oe(n(v),(p,P)=>(g(),S(z,{key:P},[p?(g(),le($,De({key:1,class:"reportViewer__page"},p.pdf,{class:[`thePage--${P+1}`],highlight:p.highlight,"page-anchor":n(u),scale:n(a).scale,onVisible:q=>n(Le)(P+1)}),null,16,["class","highlight","page-anchor","scale","onVisible"])):(g(),le(d,{key:0,class:ae(["reportViewer__page",[`theEmpty--${P+1}`]]),style:ue(n(W)),"page-number":P+1,onVisible:q=>n(ke)(P+1)},null,8,["style","class","page-number","onVisible"])),n(I)?(g(),S("div",{key:2,class:"reportViewer__page reportViewer__page--mask center pointer",style:ue(n(we)),onClick:q=>V(P+1)},Rt,12,Ot)):X("",!0)],64))),128))])):X("",!0)],512)])}}});const Ut=ie(Kt,[["__scopeId","data-v-6132997c"]]),Gt={key:0,class:"editor"},Wt={class:"editor__viewer"},eo=Y({__name:"[reportId]",setup(y){const m=Ke(),l=w(()=>Number.parseInt(m.params.reportId)),{report:x,reportFieldList:k,isDataReady:E,meta:h}=Qe(l.value),u=w(()=>Number.parseInt(m.query.fieldId)),r=w(()=>k.value.find(A=>A.id===u.value)||k.value[0]),v=w(()=>h(r.value)),f=_({page:1,highlight:""}),C=_([]),I=_(0);function T(c){I.value=c}function b(c){f.value=c}function V(c){C.value=c}const o=Ue(),s=w(()=>k.value.findIndex(c=>c.id===u.value));function a(){let c=s.value+1;c===k.value.length&&(c=0),o.push({name:"profession-editor-reportId",params:{reportId:l.value},query:{fieldId:k.value[c].id}})}function M(){let c=s.value-1;c<0&&(c=k.value.length-1),o.push({name:"profession-editor-reportId",params:{reportId:l.value},query:{fieldId:k.value[c].id}})}function N(){window.location.reload()}return(c,A)=>{const U=It,G=Ut;return n(E)?(g(),S("div",Gt,[se(U,{class:"editor__control br b--moon-gray",report:n(x),"report-field":n(r),"field-meta":n(v),onPage:b,onMatchedPages:V,onNext:a,onPrev:M},null,8,["report","report-field","field-meta"]),t("div",Wt,[n(f)?(g(),le(G,{key:0,year:n(x).year,report:n(x),page:n(f).page,highlight:n(f).highlight,"matched-pages":n(C),onViewPage:T,onReload:N},null,8,["year","report","page","highlight","matched-pages"])):X("",!0)])])):X("",!0)}}});export{eo as default};
